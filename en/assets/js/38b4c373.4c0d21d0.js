"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1892],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),c=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(n),m=a,f=d["".concat(s,".").concat(m)]||d[m]||u[m]||i;return n?r.createElement(f,o(o({ref:t},p),{},{components:n})):r.createElement(f,o({ref:t},p))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var c=2;c<i;c++)o[c]=n[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},6730:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var r=n(87462),a=(n(67294),n(3905));const i={},o="Development function",l={unversionedId:"serverless/serverless_dev",id:"serverless/serverless_dev",title:"Development function",description:"Initialization code",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/serverless/serverless_dev.md",sourceDirName:"serverless",slug:"/serverless/serverless_dev",permalink:"/en/docs/serverless/serverless_dev",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/serverless/serverless_dev.md",tags:[],version:"current",frontMatter:{},sidebar:"serverless",previous:{title:"Migrate from Serverless v2 to v3",permalink:"/en/docs/serverless/serverless_v2_upgrade_serverless_v3"},next:{title:"Test function",permalink:"/en/docs/serverless/serverless_testing"}},s={},c=[{value:"Initialization code",id:"initialization-code",level:2},{value:"Directory structure",id:"directory-structure",level:2},{value:"Function file",id:"function-file",level:2},{value:"Function definition file",id:"function-definition-file",level:2},{value:"Trigger decorator parameters",id:"trigger-decorator-parameters",level:2},{value:"Function decorator parameters",id:"function-decorator-parameters",level:2},{value:"Local development",id:"local-development",level:2},{value:"Deployment function",id:"deployment-function",level:2}],p={toc:c};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"development-function"},"Development function"),(0,a.kt)("h2",{id:"initialization-code"},"Initialization code"),(0,a.kt)("p",null,"Let's develop the first pure HTTP function to try to deploy it to the cloud environment (don't worry, functions now have a free quota, usually at no cost)."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm -v\n\n# if it is npm v6\n$ npm init midway --type=faas-v3 my_midway_app\n\n# if it is npm v7\n$ npm init midway -- --type=faas-v3 my_midway_app\n")),(0,a.kt)("p",null,"You can also run ",(0,a.kt)("inlineCode",{parentName:"p"},"npm init midway")," and select ",(0,a.kt)("inlineCode",{parentName:"p"},"faas")," scaffolding."),(0,a.kt)("h2",{id:"directory-structure"},"Directory structure"),(0,a.kt)("p",null,"The following is the simplest structure of a function. The core will include a standardized ",(0,a.kt)("inlineCode",{parentName:"p"},"f.yml")," function file and the TypeScript project structure."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},".\n\u251c\u2500\u2500 f.yml               # standardized spec file\n\u251c\u2500\u2500 package.json        # Project Dependency\n\u251c\u2500\u2500 src\n\u2502   \u2514\u2500\u2500 function\n\u2502       \u2514\u2500\u2500 hello.ts    # function file\n\u2514\u2500\u2500 tsconfig.json\n")),(0,a.kt)("p",null,"Let's take a brief look at the contents of the document."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"f.yml")," function definition file"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"tsconfig.json")," profile TypeScript"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"src")," function source directory"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"src/function/hello.ts")," sample function file")),(0,a.kt)("p",null,"We put the function in the ",(0,a.kt)("inlineCode",{parentName:"p"},"function")," directory to better separate it from other types of code."),(0,a.kt)("h2",{id:"function-file"},"Function file"),(0,a.kt)("p",null,"Let's first look at the function file. The traditional function is a ",(0,a.kt)("inlineCode",{parentName:"p"},"function"),". In order to better conform to the midway system and use our dependency injection, it is turned into Class here."),(0,a.kt)("p",null,"With the ",(0,a.kt)("inlineCode",{parentName:"p"},"@ServerlessTrigger")," decorator, we label the method as an HTTP interface and mark the ",(0,a.kt)("inlineCode",{parentName:"p"},"path")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"method")," attributes."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide, Inject, ServerlessTrigger, ServerlessTriggerType, Query } from '@midwayjs/decorator';\nimport { Context } from '@midwayjs/faas';\n\n@Provide()\nexport class HelloHTTPService {\n  @Inject()\n  ctx: Context;\n\n  @ServerlessTrigger(ServerlessTriggerType.HTTP, {\n    path: '/',\n    method: 'get',\n  })\n  async handleHTTPEvent(@Query() name = 'midway') {\n    return 'hello ${name}';\n  }\n}\n")),(0,a.kt)("p",null,"In addition to triggers, we can also use the ",(0,a.kt)("inlineCode",{parentName:"p"},"@ServerlessFunction")," decorator to describe meta-information at the function level, such as function name, concurrency, etc."),(0,a.kt)("p",null,"In this way, when we use multiple triggers on a function, we can set it like this."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide, Inject, ServerlessFunction, ServerlessTrigger, ServerlessTriggerType, Query } from '@midwayjs/decorator';\nimport { Context } from '@midwayjs/faas';\n\n@Provide()\nexport class HelloServerlessService {\n  @Inject()\n  ctx: Context;\n\n  // Multiple triggers for one function\n  @ServerlessFunction({\n    functionName: 'abcde',\n  })\n  @ServerlessTrigger(ServerlessTriggerType.TIMER, {\n    type: 'every',\n    value: '5m',\n  })\n  @ServerlessTrigger(ServerlessTriggerType.TIMER, {\n    type: 'every',\n    value: '10m',\n  })\n  async handleTimerEvent() {\n    // TODO\n  }\n}\n")),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("p",{parentName:"admonition"},"Note that some platforms cannot place different types of triggers in the same function. For example, Alibaba Cloud stipulates that HTTP triggers and other triggers cannot take effect in the same function at the same time.")),(0,a.kt)("h2",{id:"function-definition-file"},"Function definition file"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"f.yml")," is the definition file of a function. This file is used to generate files that can be recognized by different platforms during construction. The content of the file in the example is as follows."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"service:\n  name: the name of the midway-faas-examples ## function group, which can be understood as the application name.\n\nprovider:\n  Name: aliyun ## released platform, here is ariyun\n\ncustom:\n  customDomain:\n    domainName: auto ## due to the release of HTTP service, domain names are automatically generated here and can be bound separately in the future.\n")),(0,a.kt)("h2",{id:"trigger-decorator-parameters"},"Trigger decorator parameters"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"@ServerlessTrigger")," decorator is used to define different triggers. Its parameters are each trigger information and common trigger parameters."),(0,a.kt)("p",null,"The trigger is consistent with the ",(0,a.kt)("a",{parentName:"p",href:"/docs/serverless_yml"},"f.yml definition"),". please refer to the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/midwayjs/midway/blob/2.x/packages/decorator/src/interface.ts#L141"},"interface")," of each trigger for the current definition."),(0,a.kt)("p",null,"For example, the name of the trigger is changed to abc."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"  @ServerlessTrigger(ServerlessTriggerType.TIMER, {\n    name: 'abc',\n    type: 'every',\n    value: '5m',\n  })\n")),(0,a.kt)("h2",{id:"function-decorator-parameters"},"Function decorator parameters"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"@ServerlessFunction")," decorator is used to define functions through which function names can be modified."),(0,a.kt)("p",null,"The function trigger is consistent with the ",(0,a.kt)("a",{parentName:"p",href:"/docs/serverless_yml#f1568472"},"f.yml definition"),". please refer to the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/midwayjs/midway/blob/2.x/packages/decorator/src/interface.ts#L141"},"interface")," of each trigger for the current definition."),(0,a.kt)("p",null,"For example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"@ServerlessFunction({\n  functionName: 'abcde',\n  initTimeout: 3, // initialization timeout, only valid for Aliyun fc, default 3s\n  timeout: 3 // function execution timeout, default 3s\n})\n")),(0,a.kt)("h2",{id:"local-development"},"Local development"),(0,a.kt)("p",null,"The local development of HTTP functions is the same as that of traditional Web. Enter the following command."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm run dev\n$ open http://localhost:7001\n")),(0,a.kt)("p",null,"Midway will start the HTTP server, open the browser, access ",(0,a.kt)("a",{parentName:"p",href:"http://127.0.0.1:7001"},"http:// 127.0.0.1:7001"),", and the browser will print the ",(0,a.kt)("inlineCode",{parentName:"p"},"Hello midwayjs")," information."),(0,a.kt)("img",{src:"https://cdn.nlark.com/yuque/0/2021/png/501408/1615045887650-73a90be7-1d49-4024-82c4-fd6b5192e75e.png#height=384&id=X8Jmz&margin=%5Bobject%20Object%5D&name=image.png&originHeight=768&originWidth=1268&originalType=binary&ratio=1&size=85174&status=done&style=none&width=634",width:"634"}),(0,a.kt)("h2",{id:"deployment-function"},"Deployment function"),(0,a.kt)("p",null,"Deploy functions. You can use the release command to package and deploy functions:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm run deploy\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"If you enter the wrong information, you can re-execute the ",(0,a.kt)("inlineCode",{parentName:"p"},"npx midway-bin deploy -- resetConfig")," modification.")),(0,a.kt)("p",null,"Here, we use the Alibaba Cloud FC platform to demonstrate. For more information about how to deploy to Tencent Cloud, see ",(0,a.kt)("a",{parentName:"p",href:"deploy_to_tencent"},"Tencent Cloud Deployment"),"."),(0,a.kt)("p",null,"Alibaba Cloud deployment needs to configure ",(0,a.kt)("inlineCode",{parentName:"p"},"accountId"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"accountKey"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"accountSecret")," for the first time"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.nlark.com/yuque/0/2020/png/501408/1585718654967-11e1bcbd-5a56-4239-99e1-5a1472ad49fd.png",alt:null})),(0,a.kt)("p",null,"For related configuration, please refer to the picture below:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.nlark.com/yuque/0/2020/png/501408/1585718654949-9c14958c-3aff-403a-b89b-d03a3a95cd18.png",alt:null})),(0,a.kt)("p",null,"Click ",(0,a.kt)("a",{parentName:"p",href:"https://account.console.aliyun.com/#/secure"},"Security Settings"),"."),(0,a.kt)("hr",null),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.nlark.com/yuque/0/2020/png/501408/1585718654950-19a811c5-2cf3-4843-a619-cfd744430fae.png",alt:null})),(0,a.kt)("p",null,"Click the ",(0,a.kt)("a",{parentName:"p",href:"https://usercenter.console.aliyun.com/#/manage/ak"},"AccessKey page")," of Alibaba Cloud."),(0,a.kt)("p",null,"The overall deployment effect is as follows:"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.nlark.com/yuque/0/2021/svg/501408/1618722302423-d7d159b3-45b0-4a93-a2b1-daf50f46bc9f.svg",alt:null})),(0,a.kt)("p",null,"after publishing, obtain the current url from the console to access it."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://cdn.nlark.com/yuque/0/2021/png/501408/1618722353090-bf9e0061-ea62-46a2-a77e-57236a4e4024.png",alt:null})),(0,a.kt)("p",null,"Since the automatic domain name is turned on, Aliyun will add a temporary domain name for development and debugging free of charge, and then you can bind the new domain name yourself."))}u.isMDXComponent=!0}}]);