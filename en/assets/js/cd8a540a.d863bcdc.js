"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[33972],{3905:(e,n,t)=>{t.d(n,{Zo:()=>s,kt:()=>m});var a=t(67294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var p=a.createContext({}),c=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},s=function(e){var n=c(e.components);return a.createElement(p.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,i=e.originalType,p=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),d=c(t),m=o,y=d["".concat(p,".").concat(m)]||d[m]||u[m]||i;return t?a.createElement(y,r(r({ref:n},s),{},{components:t})):a.createElement(y,r({ref:n},s))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var i=t.length,r=new Array(i);r[0]=d;var l={};for(var p in n)hasOwnProperty.call(n,p)&&(l[p]=n[p]);l.originalType=e,l.mdxType="string"==typeof e?e:o,r[1]=l;for(var c=2;c<i;c++)r[c]=t[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},43252:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>r,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var a=t(87462),o=(t(67294),t(3905));const i={},r="Koa application migration",l={unversionedId:"serverless/migrate_koa",id:"serverless/migrate_koa",title:"Koa application migration",description:"Midway Serverless provides a general application migration scheme, which can publish the original application to the function platform without modifying the code as much as possible. with this solution, you can migrate the original koa application to the function platform for hosting as quickly and simply as possible, and enjoy the elastic bonus of the cloud native era.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/serverless/migrate_koa.md",sourceDirName:"serverless",slug:"/serverless/migrate_koa",permalink:"/en/docs/serverless/migrate_koa",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/serverless/migrate_koa.md",tags:[],version:"current",frontMatter:{},sidebar:"serverless",previous:{title:"Static website hosting",permalink:"/en/docs/serverless/migrate_static"},next:{title:"Express application migration",permalink:"/en/docs/serverless/migrate_express"}},p={},c=[{value:"Add function configuration",id:"add-function-configuration",level:2},{value:"Code modification",id:"code-modification",level:2},{value:"Static resources",id:"static-resources",level:2},{value:"Deployment",id:"deployment",level:2},{value:"Default",id:"default",level:2},{value:"Aliyun",id:"aliyun",level:3},{value:"Tencent cloud",id:"tencent-cloud",level:3},{value:"Modify the deployed function name",id:"modify-the-deployed-function-name",level:3}],s={toc:c};function u(e){let{components:n,...t}=e;return(0,o.kt)("wrapper",(0,a.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"koa-application-migration"},"Koa application migration"),(0,o.kt)("p",null,"Midway Serverless provides a general application migration scheme, which can publish the original application to the function platform without modifying the code as much as possible. with this solution, you can migrate the original koa application to the function platform for hosting as quickly and simply as possible, and enjoy the elastic bonus of the cloud native era."),(0,o.kt)("h2",{id:"add-function-configuration"},"Add function configuration"),(0,o.kt)("p",null,"Add the ",(0,o.kt)("inlineCode",{parentName:"p"},"f.yml")," file to the root directory of the code."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"service: my-koa-demo\n\nprovider:\n  name: aliyun ## cloud platform, aliyun,tencent, etc\n\ndeployType: koa ## Deployed Application Type\n\npackage:\n  exclude:\n    -package-lock.json ## Ignore package-lock.json files\n\ncustom:\n  customDomain:\n    domainName: auto ## automatically generates domain name\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Sometimes package-lock.json files will cause the deployment package to be too large (enter dev dependencies).")),(0,o.kt)("h2",{id:"code-modification"},"Code modification"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"The default app needs to be exported"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:2},(0,o.kt)("li",{parentName:"ol"},"The current file name of the project file must be ",(0,o.kt)("inlineCode",{parentName:"li"},"app.js"),"."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:3},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("inlineCode",{parentName:"li"},"index.js")," is a reserved file. Do not include this file in the project.")))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// app.js\n\nconst Koa = require('koa');\nconst Router = require('koa-router');\nconst app = new Koa();\n\n// * * * * *\n\n// Comment on the original listening\n// app.listen(3000);\n\n// Export the default app\nmodule.exports = app;\n")),(0,o.kt)("p",null,"If there is asynchronous initialization, such as connecting to a database, we provide asynchronous support."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// app.js\n\nconst Koa = require('koa');\nconst Router = require('koa-router');\nconst app = new Koa();\n\n// * * * * *\n\n// Comment on the original listening\n// app.listen(3000);\n\n// Export the default app\nmodule.exports = async () => {\n  // do some async method, like db connect\n  return app;\n};\n")),(0,o.kt)("h2",{id:"static-resources"},"Static resources"),(0,o.kt)("p",null,"If you want to build a copied directory in the root directory of the project, such as the ",(0,o.kt)("inlineCode",{parentName:"p"},"public")," directory of static files, configure the ",(0,o.kt)("inlineCode",{parentName:"p"},"package.include")," field in ",(0,o.kt)("inlineCode",{parentName:"p"},"f.yml"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"service: my-koa-demo\n\nprovider:\n  name: aliyun ## cloud platform, aliyun,tencent, etc\n\ndeployType:\n  type: koa               ## Deployed Application Type\n  version: 3.0.0\n\npackage:\n  include:\n    -public ## will be automatically packaged when written here.\n  exclude:\n    -package-lock.json ## Ignore package-lock.json files\n")),(0,o.kt)("h2",{id:"deployment"},"Deployment"),(0,o.kt)("p",null,"In the ",(0,o.kt)("inlineCode",{parentName:"p"},"package.json")," configuration Scripts script and dev dependency ",(0,o.kt)("inlineCode",{parentName:"p"},"@midwayjs/cli"),", execute ",(0,o.kt)("inlineCode",{parentName:"p"},"npm run deploy"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "devDependencies": {\n    "@midwayjs/cli": "^1.2.36"\n    ...\n  },\n  "scripts": {\n    "deploy": "midway-bin deploy ",\n    ...\n  }\n}\n')),(0,o.kt)("p",null,"Or use a different npm package to accelerate."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'{\n  "scripts": {\n    "deploy": "midway-bin deploy --npm=cnpm ",\n    ...\n  }\n}\n')),(0,o.kt)("p",null,"You can also execute commands separately."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ npx midway-bin deploy                                     ## deploy by npm\n$ npx midway-bin deploy --npm=cnpm ## deploy by cnpm\n")),(0,o.kt)("h2",{id:"default"},"Default"),(0,o.kt)("h3",{id:"aliyun"},"Aliyun"),(0,o.kt)("p",null,"By default, it is published as an http trigger. If you need an API gateway, you can modify and configure the functions structure according to the format of f.yml. At the same time, you need to configure routes on the platform."),(0,o.kt)("h3",{id:"tencent-cloud"},"Tencent cloud"),(0,o.kt)("p",null,"By default, it is published as an API gateway trigger and the gateway route is automatically configured."),(0,o.kt)("h3",{id:"modify-the-deployed-function-name"},"Modify the deployed function name"),(0,o.kt)("p",null,"You can use the name field."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"service: my-demo \n\nprovider:\n  name: aliyun ## cloud platform, aliyun,tencent, etc\n\ndeployType:\n  type: koa\n  version: 3.0.0\n  Name: app_idx ## function name\n")))}u.isMDXComponent=!0}}]);