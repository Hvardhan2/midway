"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[16266],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),s=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=s(e.components);return a.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),u=s(n),d=i,f=u["".concat(l,".").concat(d)]||u[d]||m[d]||r;return n?a.createElement(f,o(o({ref:t},p),{},{components:n})):a.createElement(f,o({ref:t},p))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:i,o[1]=c;for(var s=2;s<r;s++)o[s]=n[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},64164:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>r,metadata:()=>c,toc:()=>s});var a=n(87462),i=(n(67294),n(3905));const r={},o="Service factory",c={unversionedId:"service_factory",id:"service_factory",title:"Service factory",description:"Sometimes when writing components or services, you will encounter the situation that a service has multiple instances. At this time, the service factory (Service Factory) is suitable for this scenario.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/service_factory.md",sourceDirName:".",slug:"/service_factory",permalink:"/en/docs/service_factory",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/service_factory.md",tags:[],version:"current",frontMatter:{},sidebar:"common",previous:{title:"Pipeline",permalink:"/en/docs/pipeline"},next:{title:"Data subscription",permalink:"/en/docs/data_listener"}},l={},s=[{value:"Implement a service class",id:"implement-a-service-class",level:2},{value:"1. Implement the interface to create an instance",id:"1-implement-the-interface-to-create-an-instance",level:3},{value:"2. Add configuration and initialization methods",id:"2-add-configuration-and-initialization-methods",level:3},{value:"Get instance",id:"get-instance",level:2},{value:"Single instance",id:"single-instance",level:3},{value:"Multiple instances",id:"multiple-instances",level:3},{value:"Dynamically create an instance",id:"dynamically-create-an-instance",level:3}],p={toc:s};function m(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"service-factory"},"Service factory"),(0,i.kt)("p",null,"Sometimes when writing components or services, you will encounter the situation that a service has multiple instances. At this time, the service factory (Service Factory) is suitable for this scenario."),(0,i.kt)("p",null,"for example, our oss component creates multiple oss objects, so you need to leave many instance interfaces when writing. For this scenario, midway abstracted ",(0,i.kt)("inlineCode",{parentName:"p"},"ServiceFactory")," class."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"ServiceFactory")," is an abstract class, and every service that needs to be implemented needs to be inherited."),(0,i.kt)("p",null,"Take an http client as an example, we need to prepare a method to create an http client instance, which contains two parts:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},"Method for creating a client instance"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li",start:2},(0,i.kt)("li",{parentName:"ol"},"Configuration of Client")))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// Create client configuration\nconst config = {\n  baseUrl: '',\n  timeout: 1000\n};\n\n// Method for creating a client instance\nconst httpClient = new HTTPClient(config);\n")),(0,i.kt)("h2",{id:"implement-a-service-class"},"Implement a service class"),(0,i.kt)("p",null,"We hope to implement a service factory of the above HTTPClient to create multiple httpClient objects in midway system."),(0,i.kt)("p",null,"The service factory is also a common export class in midway. As a member of the service, for example, we can also put it in ",(0,i.kt)("inlineCode",{parentName:"p"},"src/service/httpServiceFactory.ts"),"."),(0,i.kt)("h3",{id:"1-implement-the-interface-to-create-an-instance"},"1. Implement the interface to create an instance"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"ServiceFactory")," is an abstract class for inheritance, which contains a generic type (the instance type created, for example, the following is the HTTPClient type created)."),(0,i.kt)("p",null,"We only need to inherit it, and at the same time, the general service factory is a single case."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { ServiceFactory } from '@midwayjs/core';\nimport { Provide, Scope, ScopeEnum } from '@midwayjs/decorator';\n\n@Provide()\n@Scope(ScopeEnum.Singleton)\nexport class HTTPClientServiceFactory extends ServiceFactory<HTTPClient> {\n    // ...\n}\n")),(0,i.kt)("p",null,"Since it is an abstract class, we need to implement two of these methods."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { ServiceFactory } from '@midwayjs/core';\nimport { Provide, Scope, ScopeEnum } from '@midwayjs/decorator';\n\n@Provide()\n@Scope(ScopeEnum.Singleton)\nexport class HTTPClientServiceFactory extends ServiceFactory<HTTPClient> {\n\n  // Create a single instance\n  protected createClient(config: any): any {\n    return new HTTPClient(config);\n  }\n\n  getName() {\n    return 'httpClient';\n  }\n}\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"createClient")," method is used to pass in a create service configuration (such as httpClient configuration) and return a specific instance, as in the example."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"getName")," method is used to return the name of this service factory to facilitate frame identification and log output."),(0,i.kt)("h3",{id:"2-add-configuration-and-initialization-methods"},"2. Add configuration and initialization methods"),(0,i.kt)("p",null,"We need to inject a configuration, for example, we use ",(0,i.kt)("inlineCode",{parentName:"p"},"httpClient")," as the configuration of this service."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// config.default.ts\nexport const httpClient = {\n    // ...\n}\n")),(0,i.kt)("p",null,"Then inject it into the service factory. At the same time, we also need to call the method of creating multiple instances during initialization."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { ServiceFactory } from '@midwayjs/core';\nimport { Provide, Scope, ScopeEnum } from '@midwayjs/decorator';\n\n@Provide()\n@Scope(ScopeEnum.Singleton)\nexport class HTTPClientServiceFactory extends ServiceFactory<HTTPClient> {\n\n  @Config('httpClient')\n  httpClientConfig;\n\n  @Init()\n  async init() {\n    await this.initClients(this.httpClientConfig);\n  }\n\n  protected createClient(config: any): any {\n    // Create an instance\n    return new HTTPClient(config);\n  }\n\n  getName() {\n    return 'httpClient';\n  }\n}\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"initClients")," method is implemented in the base class. It needs to pass a complete user configuration and call the ",(0,i.kt)("inlineCode",{parentName:"p"},"createClient")," in a loop to create the object and save it to memory."),(0,i.kt)("h2",{id:"get-instance"},"Get instance"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"createClient")," method only defines the method of creating objects, and we also need to define the structure of the configuration."),(0,i.kt)("p",null,"The structure of the configuration is divided into several parts:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},"The default configuration, that is, the configuration in which all objects can be reused"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li",start:2},(0,i.kt)("li",{parentName:"ol"},"Configuration required by a single instance"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li",start:3},(0,i.kt)("li",{parentName:"ol"},"Configuration required by multiple instances")))),(0,i.kt)("p",null,"Let's explain separately,"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Default Configuration")),(0,i.kt)("p",null,"The default configuration, we agreed to ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," the attribute."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// config.default.ts\nexport const httpClient = {\n  default: {\n    timeout: 3000\n  }\n}\n")),(0,i.kt)("h3",{id:"single-instance"},"Single instance"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Single Configuration")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// config.default.ts\nexport const httpClient = {\n  default: {\n    timeout: 3000\n  },\n  client: {\n    baseUrl: ''\n  }\n}\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"client")," is used to describe the structure of a single instance. The object is merged with the ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," when it is created. Use the ",(0,i.kt)("inlineCode",{parentName:"p"},"get")," method to obtain the default instance."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { HTTPClientServiceFactory } from './service/httpClientServiceFactory';\nimport { join } from 'path';\n\n@Provide()\nexport class UserService {\n  \n  @Inject()\n  serviceFactory: HTTPClientServiceFactory;\n  \n  async invoke() {\n    const httpClient = this.serviceFactory.get();\n  }\n}\n\n")),(0,i.kt)("h3",{id:"multiple-instances"},"Multiple instances"),(0,i.kt)("p",null,"Use ",(0,i.kt)("inlineCode",{parentName:"p"},"clients")," to configure multiple instances. Each key is an independent instance configuration."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// config.default.ts\nexport const httpClient = {\n  default: {\n    timeout: 3000\n  },\n  clients: {\n    aaa: {\n        baseUrl: ''\n    },\n    bbb: {\n        baseUrl: ''\n    }\n  }\n}\n")),(0,i.kt)("p",null,"use the key to obtain the instance."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { HTTPClientServiceFactory } from './service/httpClientServiceFactory';\nimport { join } from 'path';\n\n@Provide()\nexport class UserService {\n  \n  @Inject()\n  serviceFactory: HTTPClientServiceFactory;\n  \n  async invoke() {\n    \n    const aaaInstance = this.serviceFactory.get('aaa');\n    // ...\n        \n    const bbbInstance = this.serviceFactory.get('bbb');\n    // ...\n\n  }\n}\n")),(0,i.kt)("h3",{id:"dynamically-create-an-instance"},"Dynamically create an instance"),(0,i.kt)("p",null,"Instances can also be obtained dynamically through ",(0,i.kt)("inlineCode",{parentName:"p"},"createInstance")," methods of the base class."),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"Note that the createClient used here is not subclass, createClient does not contain and default configuration logic.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { HTTPClientServiceFactory } from './service/httpClientServiceFactory';\nimport { join } from 'path';\n\n@Provide()\nexport class UserService {\n\n  @Inject()\n  serviceFactory: HTTPClientServiceFactory;\n\n  async invoke() {\n\n    // config.bucket3 and config.default will be merged\n    let customHttpClient = await this.serviceFactory.createInstance({\n        baseUrl: 'xxxxx'\n    }, 'custom');\n\n    // After passing the name, you can also get it from the factory.\n    customHttpClient = this.serviceFactory.get('custom');\n\n  }\n}\n")),(0,i.kt)("p",null,"The first parameter of the ",(0,i.kt)("inlineCode",{parentName:"p"},"createInstance")," method is configuration. If you call dynamically, you can manually pass the parameter. The second parameter is a string name. If the name is passed in, the created instance will be saved in memory and can be obtained from the service factory again later."))}m.isMDXComponent=!0}}]);