"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[324],{3905:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>u});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var p=n.createContext({}),s=function(e){var t=n.useContext(p),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},c=function(e){var t=s(e.components);return n.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,p=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),m=s(r),u=a,h=m["".concat(p,".").concat(u)]||m[u]||d[u]||o;return r?n.createElement(h,i(i({ref:t},c),{},{components:r})):n.createElement(h,i({ref:t},c))}));function u(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,i=new Array(o);i[0]=m;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var s=2;s<o;s++)i[s]=r[s];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},4722:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>s});var n=r(7462),a=(r(7294),r(3905));const o={},i="Exception handling",l={unversionedId:"error_filter",id:"error_filter",title:"Exception handling",description:"Midway provides a built-in exception handler that handles all unhandled exceptions in the application. When your application code throws an exception handler, the handler catches the exception and waits for the user to handle it.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/error_filter.md",sourceDirName:".",slug:"/error_filter",permalink:"/en/docs/error_filter",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/error_filter.md",tags:[],version:"current",frontMatter:{},sidebar:"common",previous:{title:"Service and Injection",permalink:"/en/docs/service"},next:{title:"Guards",permalink:"/en/docs/guard"}},p={},s=[{value:"Http exception",id:"http-exception",level:2},{value:"Exception handler",id:"exception-handler",level:2},{value:"404 processing",id:"404-processing",level:3},{value:"500 processing",id:"500-processing",level:3},{value:"Match with Prototype",id:"match-with-prototype",level:2},{value:"Exception log",id:"exception-log",level:2},{value:"Built-in Http exception",id:"built-in-http-exception",level:2}],c={toc:s};function d(e){let{components:t,...r}=e;return(0,a.kt)("wrapper",(0,n.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"exception-handling"},"Exception handling"),(0,a.kt)("p",null,"Midway provides a built-in exception handler that handles all unhandled exceptions in the application. When your application code throws an exception handler, the handler catches the exception and waits for the user to handle it."),(0,a.kt)("p",null,"The execution position of the exception handler is behind the middleware, so it can intercept all errors thrown by the middleware and business."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://img.alicdn.com/imgextra/i2/O1CN013pvSjT1nWvsLRE4vo_!!6000000005098-2-tps-2000-524.png",alt:"err_filter"})),(0,a.kt)("h2",{id:"http-exception"},"Http exception"),(0,a.kt)("p",null,"In Http requests, Midway provides a common ",(0,a.kt)("inlineCode",{parentName:"p"},"MidwayHttpError")," type of exception, which inherits from standard ",(0,a.kt)("inlineCode",{parentName:"p"},"MidwayError"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"export class MidwayHttpError extends MidwayError {\n  // ...\n}\n")),(0,a.kt)("p",null,"We can throw this error during the request. Since the error contains a status code, the Http program will automatically return the status code."),(0,a.kt)("p",null,"For example, the following code throws an error containing the 400 status code."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { MidwayHttpError } from '@midwayjs/core';\n\n// ...\n\nasync findAll() {\n  throw new MidwayHttpError('my custom error', HttpStatus.BAD_REQUEST);\n}\n\n// got status: 400\n")),(0,a.kt)("p",null,"However, we seldom do this in general. Most business errors are reused and error messages are basically fixed. In order to reduce duplicate definitions, we can customize some exception types."),(0,a.kt)("p",null,"For example, to customize an Http exception with a status code of 400, you can define an error as follows."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/error/custom.error.ts\nimport { HttpStatus } from '@midwayjs/core';\n\nexport class CustomHttpError extends MidwayHttpError {\n  constructor() {\n    super('my custom error', HttpStatus.BAD_REQUEST);\n  }\n}\n")),(0,a.kt)("p",null,"Then throw the use in the business."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { CustomHttpError } from './error/custom.error';\n\n// ...\n\nasync findAll() {\n  throw new CustomHttpError();\n}\n")),(0,a.kt)("h2",{id:"exception-handler"},"Exception handler"),(0,a.kt)("p",null,"The built-in exception handler is used in standard request response scenarios and can catch errors thrown in all requests."),(0,a.kt)("p",null,"You can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"@Catch")," decorator to define a specific type of exception handler. You can easily catch a specific type of error and handle it. You can also catch a global error and return a unified format."),(0,a.kt)("p",null,"At the same time, the framework also provides some default Http errors, which are placed under the ",(0,a.kt)("inlineCode",{parentName:"p"},"httpError")," object."),(0,a.kt)("p",null,"For example, capture ",(0,a.kt)("inlineCode",{parentName:"p"},"InternalServerErrorError")," errors thrown."),(0,a.kt)("p",null,"We can place this type of exception handler in the ",(0,a.kt)("inlineCode",{parentName:"p"},"filter")," directory, such as ",(0,a.kt)("inlineCode",{parentName:"p"},"src/filter/internal.filter.ts"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/filter/internal.filter.ts\nimport { Catch } from '@midwayjs/decorator';\nimport { httpError, MidwayHttpError } from '@midwayjs/core';\nimport { Context } from '@midwayjs/koa';\n\n@Catch(httpError.InternalServerErrorError)\nexport class InternalServerErrorFilter {\n  async catch(err: MidwayHttpError, ctx: Context) {\n\n    // ...\n    return 'got 500 error, '+ err.message;\n  }\n}\n")),(0,a.kt)("p",null,"The parameters of the ",(0,a.kt)("inlineCode",{parentName:"p"},"catch")," method are the current error and the context ",(0,a.kt)("inlineCode",{parentName:"p"},"Context")," to which the exception handler is currently applied. We can simply return the response data."),(0,a.kt)("p",null,"If you do not write parameters, all errors will be captured, whether HttpError or not, and only errors thrown in the request will be captured here."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/filter/all.filter.ts\nimport { Catch } from '@midwayjs/decorator';\nimport { Context } from '@midwayjs/koa';\n\n@Catch()\nexport class AllErrorFilter {\n  async catch(err: Error, ctx: Context) {\n    // ...\n  }\n}\n")),(0,a.kt)("p",null,"The defined exception handler is just a piece of common code, and we also need to apply it to the app of one of our frameworks, such as the app of http protocol."),(0,a.kt)("p",null,"We can apply the error handling filter in ",(0,a.kt)("inlineCode",{parentName:"p"},"src/configuration.ts"),". Since the parameters can be arrays, we can apply multiple error processors."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration, App, Catch } from '@midwayjs/decorator';\nimport { join } from 'path';\nimport * as koa from '@midwayjs/koa';\nimport { InternalServerErrorFilter } from './filter/internal.filter';\n\n@Configuration({\n  imports: [\n    koa\n  ],\n})\nexport class MainConfiguration {\n\n  @App()\n  app: koa.Application;\n\n  async onReady() {\n    this.app.useFilter([InternalServerErrorFilter]);\n  }\n}\n\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"Note that some non-Midway middleware or status codes set inside the framework cannot be intercepted because they do not use the form of error throwing. If more than 400 states are returned in the business, please use the standard form of error throwing as much as possible to facilitate the interceptor to handle.")),(0,a.kt)("h3",{id:"404-processing"},"404 processing"),(0,a.kt)("p",null,"Inside the framework, if there is no match to the route, a ",(0,a.kt)("inlineCode",{parentName:"p"},"NotFoundError")," exception will be thrown. With the exception handler, we can customize its behavior."),(0,a.kt)("p",null,"For example, jump to a page, or return a specific result:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/filter/notfound.filter.ts\nimport { Catch } from '@midwayjs/decorator';\nimport { httpError, MidwayHttpError } from '@midwayjs/core';\nimport { Context } from '@midwayjs/koa';\n\n@Catch(httpError.NotFoundError)\nexport class NotFoundFilter {\n  async catch(err: MidwayHttpError, ctx: Context) {\n    // 404 error will come here\n    ctx.redirect('/404.html');\n\n    // or directly return a content\n    return {\n      message: '404, '+ ctx.path\n    }\n  }\n}\n")),(0,a.kt)("h3",{id:"500-processing"},"500 processing"),(0,a.kt)("p",null,"When decorator parameters are not passed, all errors will be captured."),(0,a.kt)("p",null,"For example, capture all errors and return a specific JSON structure, as shown in the following example."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/filter/default.filter.ts\n\nimport { Catch } from '@midwayjs/decorator';\nimport { Context } from '@midwayjs/koa';\n\n@Catch()\nexport class DefaultErrorFilter {\n  async catch(err: Error, ctx: Context) {\n\n    // ...\n    return {\n      status: err.status ?? 500,\n      message: err.message;\n    }\n  }\n\n}\n")),(0,a.kt)("p",null,"We can apply the error handling filter in ",(0,a.kt)("inlineCode",{parentName:"p"},"src/configuration.ts"),". Since the parameters can be arrays, we can apply multiple error processors."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Configuration, App, Catch } from '@midwayjs/decorator';\nimport { join } from 'path';\nimport * as koa from '@midwayjs/koa';\nimport { DefaultErrorFilter } from './filter/default.filter';\nimport { NotFoundFilter } from './filter/notfound.filter';\n\n@Configuration({\n  imports: [\n    koa\n  ],\n})\nexport class MainConfiguration {\n\n  @App()\n  app: koa.Application;\n\n  async onReady() {\n    this.app.useFilter([NotFoundFilter, DefaultErrorFilter]);\n  }\n}\n\n")),(0,a.kt)("p",null,"There is no need to consider the order when using an exception handler. The general error handler must be matched at last, and there can only be one general error handler on an app."),(0,a.kt)("h2",{id:"match-with-prototype"},"Match with Prototype"),(0,a.kt)("p",null,"By default, exceptions only make absolute matches."),(0,a.kt)("p",null,"Sometimes we need to capture all derived classes, this time we need additional settings."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Catch } from '@midwayjs/decorator';\nimport { Context } from '@midwayjs/koa';\nimport { MidwayError } from '@midwayjs/core';\n\nclass CustomError extends MidwayError {}\n\nclass CustomError2 extends MidwayError {}\n\n// All subclasses will be captured here\n@Catch([MidwayError], {\n  matchPrototype: true\n})\nclass TestFilter {\n  catch(err, ctx) {\n    // ...\n  }\n}\n")),(0,a.kt)("p",null,"The configuration ",(0,a.kt)("inlineCode",{parentName:"p"},"matchPrototype")," can match all derived classes."),(0,a.kt)("h2",{id:"exception-log"},"Exception log"),(0,a.kt)("p",null,"Midway has built-in default exception handling behavior."),(0,a.kt)("p",null,"If the exception handler is ",(0,a.kt)("strong",{parentName:"p"},"not matched"),", it will be blocked and recorded by the exception middleware."),(0,a.kt)("p",null,"Conversely, if the exception handler is customized, the error will be regarded as normal business logic. Please note that the exception thrown by the bottom layer will be used as the normal processing logic of the business at this time, and ",(0,a.kt)("strong",{parentName:"p"},"will not")," be treated as normal business logic by logging."),(0,a.kt)("p",null,"You can print the log in the exception handler yourself."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Catch } from '@midwayjs/decorator';\nimport { Context } from '@midwayjs/koa';\n\n@Catch()\nexport class DefaultErrorFilter {\n  async catch(err: Error, ctx: Context) {\n\n    // ...\n    ctx.logger.error(err);\n    // ...\n    return 'got 500 error, '+ err.message;\n  }\n}\n")),(0,a.kt)("h2",{id:"built-in-http-exception"},"Built-in Http exception"),(0,a.kt)("p",null,"The Http exceptions built into the following frameworks can be found and used in ",(0,a.kt)("inlineCode",{parentName:"p"},"@midwayjs/core"),". Each exception already contains the default error message and status code."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"BadRequestError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"UnauthorizedError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"NotFoundError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"ForbiddenError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"NotAcceptableError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"RequestTimeoutError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"ConflictError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"GoneError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"PayloadTooLargeError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"UnsupportedMediaTypeError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"UnprocessableEntityError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"InternalServerErrorError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"NotImplementedError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"BadGatewayError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"ServiceUnavailableError")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"GatewayTimeoutError"))),(0,a.kt)("p",null,"For example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { httpError } from '@midwayjs/core';\n\n// ...\n\nasync findAll() {\n  // something wrong\n  throw new httpError.InternalServerErrorError();\n}\n\n// got status: 500\n\n")))}d.isMDXComponent=!0}}]);