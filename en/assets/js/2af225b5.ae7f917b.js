"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[50450],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>k});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var p=a.createContext({}),s=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=s(e.components);return a.createElement(p.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,p=e.parentName,d=r(e,["components","mdxType","originalType","parentName"]),c=s(n),u=o,k=c["".concat(p,".").concat(u)]||c[u]||m[u]||i;return n?a.createElement(k,l(l({ref:t},d),{},{components:n})):a.createElement(k,l({ref:t},d))}));function k(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,l=new Array(i);l[0]=u;var r={};for(var p in t)hasOwnProperty.call(t,p)&&(r[p]=t[p]);r.originalType=e,r[c]="string"==typeof e?e:o,l[1]=r;for(var s=2;s<i;s++)l[s]=n[s];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},84275:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>m,frontMatter:()=>i,metadata:()=>r,toc:()=>s});var a=n(87462),o=(n(67294),n(3905));const i={},l="Start-up and deployment",r={unversionedId:"deployment",id:"deployment",title:"Start-up and deployment",description:"Midway provides a lightweight launcher to launch your application. null",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/deployment.md",sourceDirName:".",slug:"/deployment",permalink:"/en/docs/deployment",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/deployment.md",tags:[],version:"current",frontMatter:{},sidebar:"common",previous:{title:"Use components",permalink:"/en/docs/midway_component"},next:{title:"Dependency injection",permalink:"/en/docs/container"}},p={},s=[{value:"Local development",id:"local-development",level:2},{value:"Quickly start a single service",id:"quickly-start-a-single-service",level:3},{value:"Specify the portal to start the service",id:"specify-the-portal-to-start-the-service",level:3},{value:"Deploy to server",id:"deploy-to-server",level:2},{value:"The difference between post-deployment and local development",id:"the-difference-between-post-deployment-and-local-development",level:3},{value:"Deploy process",id:"deploy-process",level:3},{value:"Compile code and install dependencies",id:"compile-code-and-install-dependencies",level:3},{value:"Alias path problem in build",id:"alias-path-problem-in-build",level:3},{value:"Packing compression",id:"packing-compression",level:3},{value:"Upload and decompress",id:"upload-and-decompress",level:3},{value:"Start the project",id:"start-the-project",level:3},{value:"Startup parameters",id:"startup-parameters",level:3},{value:"Deploy with Docker",id:"deploy-with-docker",level:2},{value:"Write Dockerfile and build images",id:"write-dockerfile-and-build-images",level:3},{value:"Combined with Docker-Compose operation",id:"combined-with-docker-compose-operation",level:3},{value:"Single file build deployment",id:"single-file-build-deployment",level:2},{value:"pre-dependency",id:"pre-dependency",level:3},{value:"Code adjustments",id:"code-adjustments",level:3},{value:"1. Configuration format adjustment",id:"1-configuration-format-adjustment",level:4},{value:"2. The default export situation",id:"2-the-default-export-situation",level:4},{value:"3. Data source entities related",id:"3-data-source-entities-related",level:4},{value:"Modify the entry file",id:"modify-the-entry-file",level:3},{value:"Construct",id:"construct",level:3},{value:"Binary deployment",id:"binary-deployment",level:2},{value:"pre-dependency",id:"pre-dependency-1",level:3},{value:"Code adjustments",id:"code-adjustments-1",level:3},{value:"Modify the entry file",id:"modify-the-entry-file-1",level:3},{value:"Construct",id:"construct-1",level:3},{value:"Deployment failure",id:"deployment-failure",level:2}],d={toc:s},c="wrapper";function m(e){let{components:t,...n}=e;return(0,o.kt)(c,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"start-up-and-deployment"},"Start-up and deployment"),(0,o.kt)("p",null,"Midway provides a lightweight launcher to launch your application. null"),(0,o.kt)("h2",{id:"local-development"},"Local development"),(0,o.kt)("p",null,"Here are two ways to use the ",(0,o.kt)("inlineCode",{parentName:"p"},"dev")," command for local development."),(0,o.kt)("h3",{id:"quickly-start-a-single-service"},"Quickly start a single service"),(0,o.kt)("p",null,"In local development, Midway provides a ",(0,o.kt)("inlineCode",{parentName:"p"},"dev")," command startup framework in ",(0,o.kt)("inlineCode",{parentName:"p"},"package.json"),", such:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "script": {\n    "dev": "midway-bin dev --ts"\n  }\n}\n')),(0,o.kt)("p",null,"This is the most concise command, it has the following characteristics:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"Use ",(0,o.kt)("inlineCode",{parentName:"li"},"--ts")," to specify the TypeScript(ts-node) environment to start"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:2},(0,o.kt)("li",{parentName:"ol"},"Use the built-in API(@midwayjs/core ",(0,o.kt)("inlineCode",{parentName:"li"},"initializeGlobalApplicationContext"),") to create a service without ",(0,o.kt)("inlineCode",{parentName:"li"},"bootstrap.js")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:3},(0,o.kt)("li",{parentName:"ol"},"Single process operation")))),(0,o.kt)("p",null,"Run the following command on the command line to execute."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm run dev\n")),(0,o.kt)("h3",{id:"specify-the-portal-to-start-the-service"},"Specify the portal to start the service"),(0,o.kt)("p",null,"Because the local dev command is usually different from the initialization parameters of the ",(0,o.kt)("inlineCode",{parentName:"p"},"bootstrap.js")," startup file, some users are worried about the inconsistency between local development and online development, such as testing links."),(0,o.kt)("p",null,"In this case, you can directly pass an entry file to the ",(0,o.kt)("inlineCode",{parentName:"p"},"dev")," command and use the entry file to start the service."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "script": {\n    "dev": "midway-bin dev --ts --entryFile=bootstrap.js"\n  }\n}\n')),(0,o.kt)("h2",{id:"deploy-to-server"},"Deploy to server"),(0,o.kt)("h3",{id:"the-difference-between-post-deployment-and-local-development"},"The difference between post-deployment and local development"),(0,o.kt)("p",null,"After deployment, some places are different from local development."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"1. Changes in the node environment")),(0,o.kt)("p",null,"The biggest difference is that after the server is deployed, node will be used directly to start the project instead of ts-node, which means that the ",(0,o.kt)("inlineCode",{parentName:"p"},"*.ts")," file will no longer be read."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"2. Changes in the loading directory")),(0,o.kt)("p",null,"After the server is deployed, only the built ",(0,o.kt)("inlineCode",{parentName:"p"},"dist")," directory is loaded, while the local development ",(0,o.kt)("inlineCode",{parentName:"p"},"src")," directory is loaded."),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null}),(0,o.kt)("th",{parentName:"tr",align:null},"Local"),(0,o.kt)("th",{parentName:"tr",align:null},"Server"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"appDir"),(0,o.kt)("td",{parentName:"tr",align:null},"Project root directory"),(0,o.kt)("td",{parentName:"tr",align:null},"Project root directory")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"baseDir"),(0,o.kt)("td",{parentName:"tr",align:null},"src directory under the root directory of the project"),(0,o.kt)("td",{parentName:"tr",align:null},"dist directory under the root directory of the project")))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"3. Changes in the environment")),(0,o.kt)("p",null,"In the server environment, ",(0,o.kt)("inlineCode",{parentName:"p"},"NODE_ENV=production")," is generally used. Many libraries will provide better performance methods in this environment, such as enabling caching, error reporting, etc."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"4. Log files")),(0,o.kt)("p",null,"In the general server environment, logs are not printed to the logs directory of the project, but other directories that are not affected by project updates, such as ",(0,o.kt)("inlineCode",{parentName:"p"},"home/admin/logs"),". This fixed directory also facilitates other tools to collect logs."),(0,o.kt)("h3",{id:"deploy-process"},"Deploy process"),(0,o.kt)("p",null,"The entire deployment is divided into several parts. Since Midway is written TypeScript, it adds a build step to the traditional JavaScript code. The entire deployment process is as follows."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://img.alicdn.com/imgextra/i3/O1CN01wSpCuM27pWGTDeDyK_!!6000000007846-2-tps-2212-242.png",alt:null}),"\nSince deployment is very relevant to the platform and environment, we will demonstrate it with Linux below, and other platforms can refer to it as appropriate."),(0,o.kt)("h3",{id:"compile-code-and-install-dependencies"},"Compile code and install dependencies"),(0,o.kt)("p",null,"Since Midway project is TypeScript written, we compile it before deployment. In this example, we have written the build script in advance and run the ",(0,o.kt)("inlineCode",{parentName:"p"},"npm run build")," command. If not, add the following ",(0,o.kt)("inlineCode",{parentName:"p"},"build")," command to ",(0,o.kt)("inlineCode",{parentName:"p"},"package.json"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'// package.json\n{\n  "scripts": {\n    "build": "midway-bin build -c"\n  },\n}\n')),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Although it is not necessary, it is recommended that you perform the test and lint first.")),(0,o.kt)("p",null,"Generally speaking, the deployment build environment and the local development environment are two sets. We recommend building your application in a clean environment."),(0,o.kt)("p",null,"The following code is a sample script that you can save as ",(0,o.kt)("inlineCode",{parentName:"p"},"build.sh"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"## Server build (code downloaded)\n$ npm install             # installation and development period dependency\n$ npm run build           # build project\n$ npm prune --production  # remove development dependencies\n\n## Local build (dev dependency has been installed)\n$ npm run build\n$ npm prune --production  # remove development dependencies\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"General installation dependencies specify ",(0,o.kt)("inlineCode",{parentName:"p"},"NODE_ENV = production")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"npm install-production")," only dependencies dependencies are installed when building formal packages. Because the modules in the devDependencies are too large and will not be used in the production environment, unknown problems may also be encountered after installation.")),(0,o.kt)("p",null,"After the build is completed, the ",(0,o.kt)("inlineCode",{parentName:"p"},"dist")," directory of the Midway build product appears."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-text"},"\u279c  my_midway_app tree\n.\n\u251c\u2500\u2500 src\n\u251c\u2500\u2500 dist                # Midway build product directory\n\u251c\u2500\u2500 node_modules        # Node.js dependency package directory.\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 bootstrap.js        # Deployment Startup File\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 tsconfig.json\n")),(0,o.kt)("h3",{id:"alias-path-problem-in-build"},"Alias path problem in build"),(0,o.kt)("p",null,"Aliases are a habit brought by front-end tools, rather than a standard capability of Node.js. Currently, there are two optional ways to use them:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"Use the ",(0,o.kt)("a",{parentName:"li",href:"https://nodejs.org/dist/latest/docs/api/packages.html#subpath-imports"},"subpath imports")," that comes with Node.js"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:2},(0,o.kt)("li",{parentName:"ol"},"Use ",(0,o.kt)("a",{parentName:"li",href:"/docs/faq/alias_path"},"extra tools")," to process at compile time")))),(0,o.kt)("h3",{id:"packing-compression"},"Packing compression"),(0,o.kt)("p",null,"After the construction is completed, you can simply package and compress it and upload it to the environment to be released."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Generally speaking, the files or directories that must be included in the server operation are ",(0,o.kt)("inlineCode",{parentName:"p"},"package.json"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"bootstrap.js"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"dist"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"node_modules"),".")),(0,o.kt)("h3",{id:"upload-and-decompress"},"Upload and decompress"),(0,o.kt)("p",null,"There are many ways to upload to the server, such as the common ",(0,o.kt)("inlineCode",{parentName:"p"},"ssh/FTP/git")," etc. You can also use online services such as ",(0,o.kt)("a",{parentName:"p",href:"https://www.aliyun.com/product/oss"},"OSS")," for transfer."),(0,o.kt)("h3",{id:"start-the-project"},"Start the project"),(0,o.kt)("p",null,"The project built by Midway is single-process. Whether it adopts ",(0,o.kt)("inlineCode",{parentName:"p"},"fork")," mode or ",(0,o.kt)("inlineCode",{parentName:"p"},"cluster")," mode, single-process code is always easily compatible with different systems, so it is very easy to be loaded by existing tools such as pm2/forever in the community,"),(0,o.kt)("p",null,"Here we use pm2 to demonstrate how to deploy."),(0,o.kt)("p",null,"Projects generally need an entry file, for example, we create a ",(0,o.kt)("inlineCode",{parentName:"p"},"bootstrap.js")," in the root directory as our deployment file."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"\u279c  my_midway_app tree\n.\n\u251c\u2500\u2500 src\n\u251c\u2500\u2500 dist                # Midway build product directory\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 bootstrap.js        # Deployment Startup File\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 tsconfig.json\n")),(0,o.kt)("p",null,"Midway provides a simple way to meet the startup method of different scenarios. All we need to do is install the ",(0,o.kt)("inlineCode",{parentName:"p"},"@midwayjs/bootstrap")," module provided by us (by default, it comes with it)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm install @midwayjs/bootstrap --save\n")),(0,o.kt)("p",null,"Then write the code in the entry file. Note that the code here uses ",(0,o.kt)("inlineCode",{parentName:"p"},"JavaScript"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const { Bootstrap } = require('@midwayjs/bootstrap');\nBootstrap.run();\n")),(0,o.kt)("p",null,"Although the code of the startup file is very simple, we still need this file, which is needed in subsequent scenarios such as link tracking."),(0,o.kt)("p",null,"Note that there is no http startup port here. If you need it, you can refer to the document for modification."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"[Modify the koa port]","(extensions/koa# Modify Port)")),(0,o.kt)("p",null,"At this time, you can directly use ",(0,o.kt)("inlineCode",{parentName:"p"},"NODE_ENV = production node bootstrap.js")," to start the code, or you can use pm2 to perform the startup."),(0,o.kt)("p",null,"We generally recommend using tools to start the Node.js project. Here are some documents for advanced reading."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"extensions/pm2"},"Use documentation for pm2")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"extensions/cfork"},"cfork documentation"))),(0,o.kt)("h3",{id:"startup-parameters"},"Startup parameters"),(0,o.kt)("p",null,"In most cases, it is not necessary to configure parameters in the Bootstrap, but there are still some configurable startup parameter options that are passed in through ",(0,o.kt)("inlineCode",{parentName:"p"},"configure")," methods."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const { Bootstrap } = require('@midwayjs/bootstrap');\nBootstrap\n  .configure({\n    imports: [/*...*/]\n  })\n  .run();\n")),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Property"),(0,o.kt)("th",{parentName:"tr",align:null},"Type"),(0,o.kt)("th",{parentName:"tr",align:null},"Description"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"appDir"),(0,o.kt)("td",{parentName:"tr",align:null},"string"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional. The project root directory is ",(0,o.kt)("inlineCode",{parentName:"td"},"process.cwd()")," by default.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"baseDir"),(0,o.kt)("td",{parentName:"tr",align:null},"string"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional. The directory of the project code, which is ",(0,o.kt)("inlineCode",{parentName:"td"},"src")," in R & D and ",(0,o.kt)("inlineCode",{parentName:"td"},"dist")," in R & D.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"imports"),(0,o.kt)("td",{parentName:"tr",align:null},"Component []"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional, explicit component reference")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"moduleDetector"),(0,o.kt)("td",{parentName:"tr",align:null},"'file' ","|"," IFileDetector ","|"," false"),(0,o.kt)("td",{parentName:"tr",align:null},"Optional. The module loading method used. Default value: ",(0,o.kt)("inlineCode",{parentName:"td"},"file"),". You can use the dependency injection local file scanning method. You can explicitly specify a scanner or disable scanning.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"logger"),(0,o.kt)("td",{parentName:"tr",align:null},"Boolean ","|"," ILogger"),(0,o.kt)("td",{parentName:"tr",align:null},"optional. the logger used in the bootstrap. the default value is consoleLogger")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"ignore"),(0,o.kt)("td",{parentName:"tr",align:null},"string []"),(0,o.kt)("td",{parentName:"tr",align:null},"optional. the path ignored by the dependent injection container scan. the moduleDetector is invalid if false")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"globalConfig"),(0,o.kt)("td",{parentName:"tr",align:null},"Array<{ ","[environmentName: string]",": Record<string, any> }> ","|"," Record<string, any>"),(0,o.kt)("td",{parentName:"tr",align:null},"Optionally, if the global incoming configuration is an object, it is directly merged into the current configuration in the form of an object. If you want to pass in the configuration of different environments, it is passed in in the form of an array with the same structure and ",(0,o.kt)("inlineCode",{parentName:"td"},"importConfigs"),".")))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Example: Enter the global configuration (object)")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const { Bootstrap } = require('@midwayjs/bootstrap');\nBootstrap\n  .configure({\n    globalConfig: {\n      customKey: 'abc'\n    }\n  })\n  .run();\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Example, incoming sub-environment configuration")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const { Bootstrap } = require('@midwayjs/bootstrap');\nBootstrap\n  .configure({\n    globalConfig: [{\n      default: {/*...*/}\n      unittest: {/*...*/}\n    }]\n  })\n  .run();\n")),(0,o.kt)("h2",{id:"deploy-with-docker"},"Deploy with Docker"),(0,o.kt)("h3",{id:"write-dockerfile-and-build-images"},"Write Dockerfile and build images"),(0,o.kt)("p",null,"Step 1: Add a Dockerfile to the current directory"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-dockerfile"},'FROM node:18\n\nWORKDIR /app\n\nENV TZ="Asia/Shanghai"\n\nCOPY . .\n\n# If each company has its own private source, it can replace the registry address\nRUN npm install --registry=https://registry.npm.taobao.org\n\nRUN npm run build\n\n# If the port is changed, this side can be updated\nEXPOSE 7001\n\nCMD ["npm", "run", "online"]\n')),(0,o.kt)("p",null,"Step 2: Add ",(0,o.kt)("inlineCode",{parentName:"p"},".dockerignore")," file (similar to git ignore file), you can copy the content of ",(0,o.kt)("inlineCode",{parentName:"p"},".gitignore")," to ",(0,o.kt)("inlineCode",{parentName:"p"},".dockerignore")),(0,o.kt)("p",null,"Step 3: When using pm2 deployment, change the command to ",(0,o.kt)("inlineCode",{parentName:"p"},"pm2-runtime start"),". For more information about pm2 deployment, see ",(0,o.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/pm2#container-support"},"pm2 container deployment instructions"),"."),(0,o.kt)("p",null,"Step 4: build a docker image"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ docker build -t helloworld.\n")),(0,o.kt)("p",null,"step 5: run docker image"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ docker run -itd -P helloworld\n")),(0,o.kt)("p",null,"The operation effect is as follows:\n",(0,o.kt)("img",{parentName:"p",src:"https://cdn.nlark.com/yuque/0/2020/png/187105/1608882492099-49160b6a-601c-4f08-ba65-b95a1335aedf.png",alt:"image.png"})),(0,o.kt)("p",null,"Then the uppercase ",(0,o.kt)("inlineCode",{parentName:"p"},"-P")," allows us to access ",(0,o.kt)("inlineCode",{parentName:"p"},"32791")," ports because we are assigned a port by default (this ",(0,o.kt)("inlineCode",{parentName:"p"},"-P")," is randomly assigned, and we can also use the ",(0,o.kt)("inlineCode",{parentName:"p"},"-p 7001:7001")," to specify a specific port)"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://cdn.nlark.com/yuque/0/2020/png/187105/1608882559686-031bcf0d-2185-42cd-a838-80f008777395.png",alt:"image.png"})),(0,o.kt)("p",null,"For other registry pushed to dockerhub or docker, you can search for the corresponding method."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Optimization")),(0,o.kt)("p",null,"We can see that the mirror image we typed in front has more than 1g, which can be optimized:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"We can use a simpler basic image of docker image: for example, node:18-alpine,"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:2},(0,o.kt)("li",{parentName:"ol"},"The source code was finally typed in the mirror image. In fact, we don't need this one.")))),(0,o.kt)("p",null,"We can also combine the multistage functions of docker to do some optimization. Please note that this function can only be used after ",(0,o.kt)("inlineCode",{parentName:"p"},"Docker 17.05"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-dockerfile"},'FROM node:18 AS build\n\nWORKDIR /app\n\nCOPY . .\n\nRUN npm install\n\nRUN npm run build\n\nFROM node:18-alpine\n\nWORKDIR /app\n\n# Copy the source code and the error can be reported to the right line\nCOPY --from=build /app/src ./src\nCOPY --from=build /app/dist ./dist\nCOPY --from=build /app/bootstrap.js ./\nCOPY --from=build /app/package.json ./\n\nRUN apk add --no-cache tzdata\n\nENV TZ="Asia/Shanghai"\n\nRUN npm install --production\n\n# If the port is changed, this side can be updated\nEXPOSE 7001\n\nCMD ["npm", "run", "start"]\n')),(0,o.kt)("p",null,"The result of the current example is only ",(0,o.kt)("inlineCode",{parentName:"p"},"207MB"),". Compared with the original ",(0,o.kt)("inlineCode",{parentName:"p"},"1.26G"),", it saves a lot of space."),(0,o.kt)("h3",{id:"combined-with-docker-compose-operation"},"Combined with Docker-Compose operation"),(0,o.kt)("p",null,"On the basis of docker deployment, you can also deploy some services related to your own services in combination with docker-compose."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Step 1")),(0,o.kt)("p",null,"Add dockerfile according to Docker deployment"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Step 2")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," file is added as follows: (here we simulate our midway project using Redis)"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'version: "3"\nservices:\n  web:\n    build: .\n    ports:\n      -"7001:7001"\n    links:\n      -redis\n  redis:\n    image: redis\n\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Step 3: Build")),(0,o.kt)("p",null,"Use command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$docker-compose build\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Step 4: Run")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$docker-compose up -d\n")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://cdn.nlark.com/yuque/0/2020/png/187105/1608884158660-02bd2d3c-08b4-4ecc-a4dd-a18d4b9d2c12.png",alt:"image.png"}),"\nSo how to use redis, for example, because docker-compose has added a redis and link."),(0,o.kt)("p",null,"For more details about docker-compose, you can see how to use docker-compose online."),(0,o.kt)("h2",{id:"single-file-build-deployment"},"Single file build deployment"),(0,o.kt)("p",null,"In some scenarios, the project is built as a single file, the deployed file can be smaller, and it can be distributed and deployed more easily. In some scenarios, it is particularly efficient, such as:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"In serverless scenarios, a single file can be deployed faster"),(0,o.kt)("li",{parentName:"ul"},"For private scenarios, a single file can be encrypted and confused more easily")),(0,o.kt)("p",null,"Midway supports building projects as a single file starting from v3."),(0,o.kt)("p",null,"Cases that are not supported are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"egg project (@midwayjs/web)"),(0,o.kt)("li",{parentName:"ul"},"The path form used by ",(0,o.kt)("inlineCode",{parentName:"li"},"importConfigs")," at the entrance imports the configured application, component"),(0,o.kt)("li",{parentName:"ul"},"Packages that are not explicitly depended on, or that contain convention-based files")),(0,o.kt)("h3",{id:"pre-dependency"},"pre-dependency"),(0,o.kt)("p",null,"Single-file builds have some pre-dependencies that need to be installed."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"## Used to generate entry\n$ npm i @midwayjs/bundle-helper --save-dev\n\n## Used to build a single file\n## install to the global\n$ npm i @vercel/ncc -g\n## Or install to project (recommended)\n$ npm i @vercel/ncc --save-dev\n")),(0,o.kt)("h3",{id:"code-adjustments"},"Code adjustments"),(0,o.kt)("p",null,"There are some possible adjustments, listed below:"),(0,o.kt)("h4",{id:"1-configuration-format-adjustment"},"1. Configuration format adjustment"),(0,o.kt)("p",null,"The configuration imported by the project must be adjusted to ",(0,o.kt)("a",{parentName:"p",href:"./env_config"},"object mode"),"."),(0,o.kt)("p",null,"Midway's official components have been adjusted to this mode. If you have your own components, please adjust to this mode to build a single file."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},'Both Midway v2/v3 support configuration loading in "object mode".')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/core';\nimport { join } from 'path';\n\nimport * as DefaultConfig from './config/config.default';\nimport * as LocalConfig from './config/config.local';\n\n@Configuration({\n   importConfigs: [\n     {\n       default: DefaultConfig,\n       local: LocalConfig\n     }\n   ]\n})\nexport class MainConfiguration {\n}\n")),(0,o.kt)("h4",{id:"2-the-default-export-situation"},"2. The default export situation"),(0,o.kt)("p",null,"Due to the default behavior of the ncc builder, please ",(0,o.kt)("strong",{parentName:"p"},"DO NOT")," use default exports in dependency injection related code."),(0,o.kt)("p",null,"for example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"export default class UserSerivce {\n   //...\n}\n")),(0,o.kt)("p",null,"After compiling, ",(0,o.kt)("inlineCode",{parentName:"p"},"UserSerivce")," cannot be injected."),(0,o.kt)("h4",{id:"3-data-source-entities-related"},"3. Data source entities related"),(0,o.kt)("p",null,"Data source-dependent scan paths are also not supported."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"export default {\n   typeorm: {\n     dataSource: {\n       default: {\n         //...\n         entities: [\n           '/abc', // not supported\n         ]\n       },\n   }\n}\n")),(0,o.kt)("p",null,"If there are too many entities, you can write a js file, scan out the entities, generate a file to the directory, and execute it every time you build."),(0,o.kt)("h3",{id:"modify-the-entry-file"},"Modify the entry file"),(0,o.kt)("p",null,"Modify the entry ",(0,o.kt)("inlineCode",{parentName:"p"},"bootstrap.js")," to the following code."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const { Bootstrap } = require('@midwayjs/bootstrap');\n\n// Explicitly introduce user code as a component\nBootstrap. configure({\n   // Here is the compiled entry, local development does not use this file\n   imports: require('./dist/index'),\n   // Disable directory scanning for dependency injection\n   moduleDetector: false,\n}).run()\n\n")),(0,o.kt)("h3",{id:"construct"},"Construct"),(0,o.kt)("p",null,"Compilation for single-file builds requires several steps:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"Build the project ts file into js"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:2},(0,o.kt)("li",{parentName:"ol"},"Use an additional compiler to package all js files into one file")))),(0,o.kt)("p",null,"We can write the above process as the following two commands, and put them in the ",(0,o.kt)("inlineCode",{parentName:"p"},"scripts")," field of ",(0,o.kt)("inlineCode",{parentName:"p"},"package.json"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'   "scripts": {\n     //...\n     "bundle": "bundle && npm run build && ncc build bootstrap.js -o build",\n     "bundle_start": "NODE_ENV=production node ./build/index.js"\n   },\n')),(0,o.kt)("p",null,"Contains three parts"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"bundle")," is to export all project codes as components and generate a ",(0,o.kt)("inlineCode",{parentName:"li"},"src/index.ts")," file, this command is provided by ",(0,o.kt)("inlineCode",{parentName:"li"},"@midwayjs/bundle-helper")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"npm run buid")," is the basic ts project build, build ",(0,o.kt)("inlineCode",{parentName:"li"},"src/**/*.ts")," to ",(0,o.kt)("inlineCode",{parentName:"li"},"dist/**/*.js")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"ncc build bootstrap.js -o build")," uses ",(0,o.kt)("inlineCode",{parentName:"li"},"bootstrap.js")," as the entry to build a single file, and finally generates it into ",(0,o.kt)("inlineCode",{parentName:"li"},"build/index.js"))),(0,o.kt)("p",null,"After writing, execute the command."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm run bundle\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Note that there may be errors during the construction process, such as ts definition errors, incorrect entry generation syntax, etc., which need to be repaired manually.")),(0,o.kt)("p",null,"After compiling, start the project."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm run bundle_start\n")),(0,o.kt)("p",null,"If boot access is fine, then you can distribute your build in the build directory."),(0,o.kt)("h2",{id:"binary-deployment"},"Binary deployment"),(0,o.kt)("p",null,"Package Node.js into a single executable file, which can be directly copied and executed during deployment. This method includes the node runtime and business code, which is conducive to the protection of intellectual property rights."),(0,o.kt)("p",null,"Common tools for packaging Node.js into executable files include ",(0,o.kt)("inlineCode",{parentName:"p"},"pkg"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"nexe"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"node-packer"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"enclose"),", etc. Below we will take the most common ",(0,o.kt)("inlineCode",{parentName:"p"},"pkg")," package as an example."),(0,o.kt)("h3",{id:"pre-dependency-1"},"pre-dependency"),(0,o.kt)("p",null,"Binary deployment has some pre-dependencies that need to be installed."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"## Used to generate entry\n$ npm i @midwayjs/bundle-helper --save-dev\n\n## for building binaries\n## install to the global\n$ npm i pkg -g\n## Or install to project (recommended)\n$ npm i pkg --save-dev\n")),(0,o.kt)("h3",{id:"code-adjustments-1"},"Code adjustments"),(0,o.kt)("p",null,"The adjustment is the same as ","[Single File Build Deployment]","(./deployment#Single File Build Deployment), please refer to the above document."),(0,o.kt)("h3",{id:"modify-the-entry-file-1"},"Modify the entry file"),(0,o.kt)("p",null,"The adjustment is the same as ","[Single File Build Deployment]","(./deployment#Single File Build Deployment), please refer to the above document."),(0,o.kt)("h3",{id:"construct-1"},"Construct"),(0,o.kt)("p",null,"First you need to configure pkg, the main content is in the ",(0,o.kt)("inlineCode",{parentName:"p"},"bin")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"pkg")," fields of ",(0,o.kt)("inlineCode",{parentName:"p"},"package.json"),"."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"bin")," we specify as the entry file, ie ",(0,o.kt)("inlineCode",{parentName:"li"},"bootstrap.js")),(0,o.kt)("li",{parentName:"ul"},"The directory after ",(0,o.kt)("inlineCode",{parentName:"li"},"pkg.scripts")," is built, using glob syntax to include all js files under ",(0,o.kt)("inlineCode",{parentName:"li"},"dist")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"pkg.asserts")," If there are some static resource files, you can configure them here"),(0,o.kt)("li",{parentName:"ul"},"The platform product built by ",(0,o.kt)("inlineCode",{parentName:"li"},"pkg.targets")," is a combination of the following options (in the example I specified mac + node18):",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"nodeRange")," (node8), node10, node12, node14, node16 or latest"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"platform")," alpine, linux, linuxstatic, win, macos, (freebsd)"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"arch")," x64, arm64, (armv6, armv7)"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"pkg.outputPath")," is the address of the build product, in order to separate it from the ts output, we chose the build directory")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"package.json")," reference example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n   "name": "my-midway-project",\n   //...\n   "devDependencies": {\n     //...\n     "@midwayjs/bundle-helper": "^1.2.0",\n     "pkg": "^5.8.1"\n   },\n   "scripts": {\n     //...\n     "build": "midway-bin build -c",\n     "pkg": "pkg . -d > build/pkg.log",\n     "bundle": "bundle && npm run build"\n   },\n   "bin": "./bootstrap.js",\n   "pkg": {\n     "scripts": "dist/**/*.js",\n     "assets": [],\n     "targets": [\n       "node18-macos-arm64"\n     ],\n     "outputPath": "build"\n   },\n   //...\n}\n\n')),(0,o.kt)("p",null,"For more details, please refer to ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/vercel/pkg"},"PKG Documentation"),"."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"In the above example, the ",(0,o.kt)("inlineCode",{parentName:"p"},"-d")," parameter of the pkg command is to output debugging information to a specific file, which can be deleted by yourself.")),(0,o.kt)("p",null,"Compilation for binary builds requires several steps:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"Generate the ",(0,o.kt)("inlineCode",{parentName:"li"},"src/index.ts")," entry file, and build the project ts file into js"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:2},(0,o.kt)("li",{parentName:"ol"},"Use pkg to generate platform-specific build products")))),(0,o.kt)("p",null,"We can execute orders."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm run bundle\n$ npm run pkg\n")),(0,o.kt)("p",null,"If it is correct, we can see a ",(0,o.kt)("inlineCode",{parentName:"p"},"my-midway-project")," file in the ",(0,o.kt)("inlineCode",{parentName:"p"},"build")," directory (the ",(0,o.kt)("inlineCode",{parentName:"p"},"name")," field of our ",(0,o.kt)("inlineCode",{parentName:"p"},"package.json"),"), double click it to execute."),(0,o.kt)("h2",{id:"deployment-failure"},"Deployment failure"),(0,o.kt)("p",null,"After deployment, the situation is more complicated because it is related to the environment. If you encounter problems after deployment to the server, see ",(0,o.kt)("a",{parentName:"p",href:"null"},"Troubleshoot server startup failure"),"."))}m.isMDXComponent=!0}}]);