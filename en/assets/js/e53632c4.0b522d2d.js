"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[49902],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>m});var i=t(67294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,i,o=function(e,n){if(null==e)return{};var t,i,o={},a=Object.keys(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var s=i.createContext({}),p=function(e){var n=i.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},c=function(e){var n=p(e.components);return i.createElement(s.Provider,{value:n},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},f=i.forwardRef((function(e,n){var t=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(t),f=o,m=d["".concat(s,".").concat(f)]||d[f]||u[f]||a;return t?i.createElement(m,r(r({ref:n},c),{},{components:t})):i.createElement(m,r({ref:n},c))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=t.length,r=new Array(a);r[0]=f;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[d]="string"==typeof e?e:o,r[1]=l;for(var p=2;p<a;p++)r[p]=t[p];return i.createElement.apply(null,r)}return i.createElement.apply(null,t)}f.displayName="MDXCreateElement"},44706:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var i=t(87462),o=(t(67294),t(3905));const a={},r="Multi-environment configuration",l={unversionedId:"env_config",id:"env_config",title:"Multi-environment configuration",description:"Configuration is a commonly used function, and different configuration information is often used in different environments.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/env_config.md",sourceDirName:".",slug:"/env_config",permalink:"/en/docs/env_config",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/env_config.md",tags:[],version:"current",frontMatter:{},sidebar:"common",previous:{title:"Operating environment",permalink:"/en/docs/environment"},next:{title:"Life cycle",permalink:"/en/docs/lifecycle"}},s={},p=[{value:"Configuration file",id:"configuration-file",level:2},{value:"Configuration file directory",id:"configuration-file-directory",level:3},{value:"Object form",id:"object-form",level:3},{value:"Function form",id:"function-form",level:3},{value:"Configuration file definition",id:"configuration-file-definition",level:3},{value:"Load configuration file in object form",id:"load-configuration-file-in-object-form",level:3},{value:"Specify directory and file loading configuration",id:"specify-directory-and-file-loading-configuration",level:3},{value:"Configure loading order",id:"configure-loading-order",level:3},{value:"Configure merge rules",id:"configure-merge-rules",level:3},{value:"get configuration",id:"get-configuration",level:2},{value:"Single configuration value",id:"single-configuration-value",level:3},{value:"Deep level configuration values",id:"deep-level-configuration-values",level:3},{value:"The entire configuration object",id:"the-entire-configuration-object",level:3},{value:"Change setting",id:"change-setting",level:2},{value:"Modification during life cycle",id:"modification-during-life-cycle",level:3},{value:"Modify at startup",id:"modify-at-startup",level:3},{value:"Modify using API",id:"modify-using-api",level:3},{value:"Environment variables and configuration",id:"environment-variables-and-configuration",level:2},{value:"Common mistakes",id:"common-mistakes",level:2},{value:"1. Obtain the value injected by @Config in the constructor",id:"1-obtain-the-value-injected-by-config-in-the-constructor",level:3},{value:"2. Mix callback and export writing methods",id:"2-mix-callback-and-export-writing-methods",level:3},{value:"3. Mix export default and export const",id:"3-mix-export-default-and-export-const",level:3},{value:"4. Export= mixed with others",id:"4-export-mixed-with-others",level:3}],c={toc:p},d="wrapper";function u(e){let{components:n,...t}=e;return(0,o.kt)(d,(0,i.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"multi-environment-configuration"},"Multi-environment configuration"),(0,o.kt)("p",null,"Configuration is a commonly used function, and different configuration information is often used in different environments."),(0,o.kt)("p",null,"In this article, we will introduce how Midway loads business configurations for different environments."),(0,o.kt)("h2",{id:"configuration-file"},"Configuration file"),(0,o.kt)("p",null,"The simplest is to use the business configuration file capabilities provided by the framework."),(0,o.kt)("p",null,"This capability is available across all business code and components throughout the Midway lifecycle."),(0,o.kt)("p",null,"Configuration files can be exported in two formats, ",(0,o.kt)("strong",{parentName:"p"},"object form")," and ",(0,o.kt)("strong",{parentName:"p"},"function form"),"."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"After our practice, ",(0,o.kt)("strong",{parentName:"p"},"object form")," will be simpler and more friendly, and can avoid many wrong usages."),(0,o.kt)("p",{parentName:"admonition"},"We will display it in this form in most documents.")),(0,o.kt)("h3",{id:"configuration-file-directory"},"Configuration file directory"),(0,o.kt)("p",null,"We can customize a directory and put the configuration file in it."),(0,o.kt)("p",null,"For example, the ",(0,o.kt)("inlineCode",{parentName:"p"},"src/config")," directory."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"\u279c  my_midway_app tree\n.\n\u251c\u2500\u2500 src\n\u2502   \u251c\u2500\u2500 config\n\u2502   \u2502   \u251c\u2500\u2500 config.default.ts\n\u2502   \u2502   \u251c\u2500\u2500 config.prod.ts\n\u2502   \u2502   \u251c\u2500\u2500 config.unittest.ts\n\u2502   \u2502   \u2514\u2500\u2500 config.local.ts\n\u2502   \u251c\u2500\u2500 interface.ts\n\u2502   \u2514\u2500\u2500 service\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 tsconfig.json\n")),(0,o.kt)("p",null,"There are some specific conventions for configuration file names."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"config.default.ts")," is the default configuration file, and all environments will load this configuration file."),(0,o.kt)("p",null,"For the rest of the file names, use ",(0,o.kt)("inlineCode",{parentName:"p"},"config.environment")," as the file name. For the concept of specific environment, please see ",(0,o.kt)("a",{parentName:"p",href:"environment"},"Running Environment"),"."),(0,o.kt)("p",null,"Configuration is not ",(0,o.kt)("strong",{parentName:"p"},"required"),", please add the environment configuration you need as appropriate."),(0,o.kt)("h3",{id:"object-form"},"Object form"),(0,o.kt)("p",null,"The configuration file export format is object, for example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { MidwayConfig } from '@midwayjs/core';\n\nexport default {\n   keys: '1639994056460_8009',\n   koa: {\n     port: 7001,\n   },\n} as MidwayConfig;\n")),(0,o.kt)("h3",{id:"function-form"},"Function form"),(0,o.kt)("p",null,"The configuration file is a function with ",(0,o.kt)("inlineCode",{parentName:"p"},"appInfo")," parameters. This function will be automatically executed when the framework is initialized, and the return value will be merged into the complete configuration object."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { MidwayAppInfo, MidwayConfig } from '@midwayjs/core';\n\nexport default (appInfo: MidwayAppInfo): MidwayConfig => {\n   return {\n     keys: '1639994056460_8009',\n     koa: {\n       port: 7001,\n     },\n     view: {\n       root: path.join(appInfo.appDir, 'view'),\n     },\n   };\n}\n\n")),(0,o.kt)("p",null,"The parameter of this function is ",(0,o.kt)("inlineCode",{parentName:"p"},"MidwayAppInfo")," type, and the value is as follows."),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},(0,o.kt)("strong",{parentName:"th"},"appInfo")),(0,o.kt)("th",{parentName:"tr",align:null},(0,o.kt)("strong",{parentName:"th"},"Description")))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"pkg"),(0,o.kt)("td",{parentName:"tr",align:null},"package.json")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"name"),(0,o.kt)("td",{parentName:"tr",align:null},"application name, same as pkg.name")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"baseDir"),(0,o.kt)("td",{parentName:"tr",align:null},"src (local development) or dist (online) directory of the application code")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"appDir"),(0,o.kt)("td",{parentName:"tr",align:null},"directory for application code")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"HOME"),(0,o.kt)("td",{parentName:"tr",align:null},"user directory, such as /home/admin for the admin account")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"root"),(0,o.kt)("td",{parentName:"tr",align:null},"Application root directory, baseDir only in local and unittest environments, and HOME in others.")))),(0,o.kt)("h3",{id:"configuration-file-definition"},"Configuration file definition"),(0,o.kt)("p",null,"Midway provides ",(0,o.kt)("inlineCode",{parentName:"p"},"MidwayConfig")," as a unified configuration item definition, and all components will merge their definitions into this configuration item definition. Whenever a component is enabled (",(0,o.kt)("inlineCode",{parentName:"p"},"imports")," in ",(0,o.kt)("inlineCode",{parentName:"p"},"configuration.ts"),"), ",(0,o.kt)("inlineCode",{parentName:"p"},"MidwayConfig")," will automatically include the configuration definition for that component."),(0,o.kt)("p",null,"For this reason, please use the format recommended by the documentation as much as possible to achieve the best usage effect."),(0,o.kt)("p",null,"Whenever a new component is enabled, the configuration definition will automatically add the configuration items of the component. Through this behavior, you can also check whether a certain component is enabled in disguise."),(0,o.kt)("p",null,"For example, we enable the effect of the view component."),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://img.alicdn.com/imgextra/i2/O1CN013sHGlA1o3uQ4Pg0nO_!!6000000005170-2-tps-1416-572.png",alt:null})),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Why use objects instead of plain key exports?"),(0,o.kt)("ol",{parentName:"admonition"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"If the user does not understand the configuration items, he still needs to check the document to understand the meaning of each item. Except for the first level of prompts, the subsequent levels of prompts do not have obvious efficiency improvements.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"The form of key export has no advantage in displaying under an overly deep structure")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"The key export may be repeated, but there will be no warnings or errors at the code level, which is difficult to troubleshoot. The object form is more friendly")))),(0,o.kt)("h3",{id:"load-configuration-file-in-object-form"},"Load configuration file in object form"),(0,o.kt)("p",null,"The framework provides the function of loading configuration files for different environments, which needs to be enabled in the ",(0,o.kt)("inlineCode",{parentName:"p"},"src/configuration.ts")," file."),(0,o.kt)("p",null,"There are two ways to load configuration, ",(0,o.kt)("strong",{parentName:"p"},"object format")," and ",(0,o.kt)("strong",{parentName:"p"},"specified directory format")," loading."),(0,o.kt)("p",null,"Starting from Midway v3, we will use ",(0,o.kt)("strong",{parentName:"p"},"object form")," as the main configuration loading form."),(0,o.kt)("p",null,"In scenarios such as single-file construction and ESM, only this standard module loading method is supported to load configurations."),(0,o.kt)("p",null,"The configuration file of each environment ",(0,o.kt)("strong",{parentName:"p"},"must explicitly specify to add"),", and subsequent frameworks will be merged according to the actual environment."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/core';\n\nimport * as DefaultConfig from './config/config.default';\nimport * as LocalConfig from './config/config.local';\n\n@Configuration({\n   importConfigs: [\n     {\n       default: DefaultConfig,\n       local: LocalConfig\n     }\n   ]\n})\nexport class MainConfiguration {\n}\n")),(0,o.kt)("p",null,"Configuration objects are passed in the array in ",(0,o.kt)("inlineCode",{parentName:"p"},"importConfigs"),". The key of each object is the environment, and the value is the configuration value corresponding to the environment. Midway will load the corresponding configuration according to the environment during startup."),(0,o.kt)("h3",{id:"specify-directory-and-file-loading-configuration"},"Specify directory and file loading configuration"),(0,o.kt)("p",null,"Specify a directory to load, and all ",(0,o.kt)("inlineCode",{parentName:"p"},"config.*.ts")," in the directory will be scanned and loaded."),(0,o.kt)("p",null,"ESM, single-file deployment, etc. do not support directory configuration loading."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"importConfigs")," here just specify the files that need to be loaded, and the actual runtime will ",(0,o.kt)("strong",{parentName:"p"},"automatically select the current environment")," to find the corresponding file suffix.")),(0,o.kt)("p",null,"The rules for the configuration file are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"You can specify a directory, the traditional ",(0,o.kt)("inlineCode",{parentName:"li"},"src/config")," directory is recommended, or you can specify a file"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:2},(0,o.kt)("li",{parentName:"ol"},"The file specification does not require the ts suffix"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:3},(0,o.kt)("li",{parentName:"ol"},"Configuration file ",(0,o.kt)("strong",{parentName:"li"},"Must be explicitly specified to add"))))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Example: specify directory")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/core';\nimport { join } from 'path';\n\n@Configuration({\n   importConfigs: [\n     join(__dirname, './config/'),\n   ]\n})\nexport class MainConfiguration {\n}\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Example: specifying a specific file")),(0,o.kt)("p",null,"When manually specifying a batch of files, if the files do not exist at this time, an error will be reported."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/core';\nimport { join } from 'path';\n\n@Configuration({\n   importConfigs: [\n     join(__dirname, './config/config.default'),\n     join(__dirname, './config/config.local'),\n     join(__dirname, './config/custom.local') // You can use custom naming, as long as the middle part has an environment\n   ]\n})\nexport class MainConfiguration {\n}\n")),(0,o.kt)("p",null,"You can also use the configuration outside the project, but please use the absolute path and ",(0,o.kt)("inlineCode",{parentName:"p"},"*.js")," suffix."),(0,o.kt)("p",null,"For example, the directory structure is as follows (note the ",(0,o.kt)("inlineCode",{parentName:"p"},"customConfig.default.js")," file):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"}," base-app\n \u251c\u2500\u2500 package.json\n \u251c\u2500\u2500 customConfig.default.js\n \u2514\u2500\u2500 src\n     \u251c\u2500\u2500 configuration.ts\n     \u2514\u2500\u2500 config\n         \u2514\u2500\u2500 config.default.ts\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/core';\nimport { join } from 'path';\n\n@Configuration({\n   importConfigs: [\n     join(__dirname, './config/'),\n     join(__dirname, '../customConfig.default'),\n   ]\n})\nexport class MainConfiguration {\n}\n")),(0,o.kt)("h3",{id:"configure-loading-order"},"Configure loading order"),(0,o.kt)("p",null,"There is a priority for configuration (Application Code > Component), and the priority will be higher relative to this running environment."),(0,o.kt)("p",null,"For example, the loading sequence for loading a configuration in the prod environment is as follows. The later loaded configuration will overwrite the previous configuration with the same name."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"-> Component config.default.ts\n-> Apply config.default.ts\n-> component config.prod.ts\n-> apply config.prod.ts\n")),(0,o.kt)("h3",{id:"configure-merge-rules"},"Configure merge rules"),(0,o.kt)("p",null,"By default, the ",(0,o.kt)("inlineCode",{parentName:"p"},"**/config.defaut.ts")," file and the ",(0,o.kt)("inlineCode",{parentName:"p"},"**/config.{environment}.ts")," file will be loaded."),(0,o.kt)("p",null,"For example, the following code will search for ",(0,o.kt)("inlineCode",{parentName:"p"},"config.default.*")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"config.local.*")," files in the ",(0,o.kt)("inlineCode",{parentName:"p"},"local")," environment. If it is in other environments, it will only search for ",(0,o.kt)("inlineCode",{parentName:"p"},"config.default.*")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"config.{Current environment}.*"),", if the file does not exist, it will not be loaded and no error will be reported."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/core';\nimport { join } from 'path';\n\n@Configuration({\n   importConfigs: [\n     join(__dirname, './config/'),\n   ]\n})\nexport class MainConfiguration {\n}\n")),(0,o.kt)("p",null,"For forward compatibility, we have done some processing on the configuration reading of some special environments. The value of the environment here refers to the ",(0,o.kt)("a",{parentName:"p",href:"environment#AxjGQ"},"result")," based on the values of ",(0,o.kt)("inlineCode",{parentName:"p"},"NODE_ENV")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"MIDWAY_SERVER_ENV"),"."),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},(0,o.kt)("strong",{parentName:"th"},"Environment value")),(0,o.kt)("th",{parentName:"tr",align:null},(0,o.kt)("strong",{parentName:"th"},"Configuration file read")))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"prod"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("em",{parentName:"td"},".default.ts + "),".prod.ts")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"production"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("em",{parentName:"td"},".default.ts + "),".production.ts + *.prod.ts")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"unittest"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("em",{parentName:"td"},".default.ts + "),".unittest.ts")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"test"),(0,o.kt)("td",{parentName:"tr",align:null},(0,o.kt)("em",{parentName:"td"},".default.ts + "),".test.ts + *.unittest.ts")))),(0,o.kt)("p",null,"Except for the above table, the rest are the values of ",(0,o.kt)("inlineCode",{parentName:"p"},"*.default.ts + *.{current environment}.ts"),"."),(0,o.kt)("p",null,"In addition, the configuration is merged using the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/eggjs/extend2"},"extend2")," module for deep copying, and the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/eggjs/extend2"},"extend2")," fork from ","[extend]","(https ://github.com/justmoon/node-extend), there will be differences when handling arrays."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const a = {\n   arr: [ 1, 2 ],\n};\nconst b = {\n   arr: [ 3 ],\n};\nextend(true, a, b);\n// => { arr: [ 3 ] }\n")),(0,o.kt)("p",null,"According to the example above, the framework directly overwrites the array instead of doing the merge."),(0,o.kt)("h2",{id:"get-configuration"},"get configuration"),(0,o.kt)("p",null,"Midway will save the configuration in the internal configuration service. The entire structure is an object, which is injected using the ",(0,o.kt)("inlineCode",{parentName:"p"},"@Config")," decorator when used by Midway business code."),(0,o.kt)("h3",{id:"single-configuration-value"},"Single configuration value"),(0,o.kt)("p",null,"By default, it will be obtained from the configuration object according to the string parameter value of the decorator."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Config } from '@midwayjs/core';\n\nexport class IndexHandler {\n\n   @Config('userService')\n   userConfig;\n\n   async handler() {\n   console.log(this.userConfig); // { appname: 'test'}\n   }\n}\n")),(0,o.kt)("h3",{id:"deep-level-configuration-values"},"Deep level configuration values"),(0,o.kt)("p",null,"If the value of the configuration object is deep in the object, it can be obtained in a cascaded manner."),(0,o.kt)("p",null,"For example, the data source is:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n   "userService": {\n   "appname": {\n       "test": {\n       "data": "xxx"\n       }\n     }\n   }\n}\n')),(0,o.kt)("p",null,"You can write complex acquisition expressions to acquire values, examples are as follows."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Config } from '@midwayjs/core';\n\nexport class IndexHandler {\n\n   @Config('userService.appname.test.data')\n   data;\n\n   async handler() {\n   console.log(this.data); // xxx\n   }\n}\n\n")),(0,o.kt)("h3",{id:"the-entire-configuration-object"},"The entire configuration object"),(0,o.kt)("p",null,"You can also get the entire configuration object through the special attribute ",(0,o.kt)("inlineCode",{parentName:"p"},"ALL"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Config, ALL } from '@midwayjs/core';\n\nexport class IndexHandler {\n\n   @Config(ALL)\n   allConfig;\n\n   async handler() {\n   console.log(this.allConfig); // { userService: { appname: 'test'}}\n   }\n}\n")),(0,o.kt)("h2",{id:"change-setting"},"Change setting"),(0,o.kt)("p",null,"During the coding process, we have some places where the configuration can be dynamically modified for use in different scenarios."),(0,o.kt)("h3",{id:"modification-during-life-cycle"},"Modification during life cycle"),(0,o.kt)("p",null,"midway has added an asynchronous configuration loading life cycle, which can be executed after the configuration is loaded."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},'// src/configuration.ts\nimport { Configuration, IMidwayContainer } from \'@midwayjs/core\';\nimport { join } from \'path\';\nimport { RemoteConfigService } from \'../service/remote\'; // Customized access to remote configuration service\n\n@Configuration({\n   importConfigs: [\n     join(__dirname, \'./config/\'),\n   ]\n})\nexport class MainConfiguration {\n  \n  async onConfigLoad(container: IMidwayContainer) {\n    // Here you can modify the global configuration\n    const remoteConfigService = await container. getAsync(RemoteConfigService);\n    const remoteConfig = await remoteConfigService.getData();\n\n    // The return value here will be merged with the global config\n    // const remoteConfig = {\n    //   typeorm: {\n    //     dataSource: {\n    //       default: {\n    //         type: "mysql",\n    //         host: "localhost",\n    //         port: 3306,\n    //         username: "root",\n    //         password: "123456",\n    //         database: "admin",\n    //         synchronize: false,\n    //         logging: false,\n    //         entities: "/**/**.entity.ts",\n    //         dateStrings: true\n    //       }\n    //     }\n    //   }\n    // }\n    \n    return remoteConfig;\n  }\n}\n')),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"The ",(0,o.kt)("inlineCode",{parentName:"p"},"onConfigLoad")," lifecycle is executed after the egg plugin (if any) is initialized and cannot be used to override the configuration of the egg plugin.")),(0,o.kt)("h3",{id:"modify-at-startup"},"Modify at startup"),(0,o.kt)("p",null,"You can add configuration using Bootstrap's ",(0,o.kt)("inlineCode",{parentName:"p"},"configure")," method before starting the code."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"configure")," method can pass a ",(0,o.kt)("inlineCode",{parentName:"p"},"globalConfig")," attribute, which can pass a global configuration before the application starts."),(0,o.kt)("p",null,"If you pass an array, you can differentiate between environments."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// bootstrap.js\nconst { Bootstrap } = require('@midwayjs/bootstrap');\nBootstrap\n  .configure({\n    globalConfig: [\n      {\n        default: {\n          abc: '123'\n        },\n        unittest: {\n          abc: '321'\n        }\n      }\n    ]\n  })\n  .run();\n\n// in unittest, app.getConfig('abc') => '321'\n")),(0,o.kt)("p",null,"If an object is passed, it is overridden directly."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// bootstrap.js\nconst { Bootstrap } = require('@midwayjs/bootstrap');\nBootstrap\n  .configure({\n    globalConfig: {\n      abc: 'text'\n    }\n  })\n  .run();\n\n// app.getConfig('abc') => 'text'\n")),(0,o.kt)("h3",{id:"modify-using-api"},"Modify using API"),(0,o.kt)("p",null,"To modify the configuration in other scenarios, you can use the ",(0,o.kt)("a",{parentName:"p",href:"./built_in_service#midwayconfigservice"},"API")," provided by midway."),(0,o.kt)("h2",{id:"environment-variables-and-configuration"},"Environment variables and configuration"),(0,o.kt)("p",null,"There are some libraries in the community, such as ",(0,o.kt)("inlineCode",{parentName:"p"},"dotenv"),", which can load ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," files and inject them into the environment, thereby placing some keys in the environment, which can be directly relied on in Midway."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i dotenv --save\n")),(0,o.kt)("p",null,"You can add a ",(0,o.kt)("inlineCode",{parentName:"p"},".env")," file in the project root directory, such as the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"OSS_SECRET=12345\nOSS_ACCESSKEY=54321\n")),(0,o.kt)("p",null,"We can initialize it in the entry, such as ",(0,o.kt)("inlineCode",{parentName:"p"},"bootstrap.js")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"configuration"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Configuration } from '@midwayjs/core';\nimport * as dotenv from 'dotenv';\n\n// load .env file in process.cwd\ndotenv.config();\n\n@Configuration({\n   //...\n})\nexport class MainConfiguration {\n   async onReady(container) {\n\n   }\n}\n\n")),(0,o.kt)("p",null,"We can use it in the environment configuration."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\n\nexport const oss = {\n   accessKey: process.env.OSS_ACCESSKEY, // 54321\n   secret: process.env.OSS_SECRET // 12345\n}\n")),(0,o.kt)("h2",{id:"common-mistakes"},"Common mistakes"),(0,o.kt)("p",null,"There are many possibilities for the configuration not taking effect. The troubleshooting ideas are as follows:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"Check whether the files or directories related to ",(0,o.kt)("inlineCode",{parentName:"li"},"importConfigs")," are explicitly configured in the configuration file."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:2},(0,o.kt)("li",{parentName:"ol"},"Check whether the application startup environment is consistent with the configuration file. For example, the prod configuration will definitely not appear in local."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:3},(0,o.kt)("li",{parentName:"ol"},"Check whether ordinary export and method callback export are mixed use, such as the following mixed use situation")))),(0,o.kt)("h3",{id:"1-obtain-the-value-injected-by-config-in-the-constructor"},"1. Obtain the value injected by @Config in the constructor"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Please don\u2019t "),"get the properties injected by ",(0,o.kt)("inlineCode",{parentName:"p"},"@Config()")," in the constructor, which will make the result undefined. The reason is that the attributes injected by the decorator will not be assigned until the instance is created (new). In this case, use the ",(0,o.kt)("inlineCode",{parentName:"p"},"@Init")," decorator."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"@Provide()\nexport class UserService {\n\n  @Config('redisConfig')\n  redisConfig;\n\n  constructor() {\n    console.log(this.redisConfig); // undefined\n  }\n\n  @Init()\n  async initMethod() {\n    console.log(this.redisConfig); // has value\n  }\n\n}\n")),(0,o.kt)("h3",{id:"2-mix-callback-and-export-writing-methods"},"2. Mix callback and export writing methods"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"The following is incorrect usage. ")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"export default (appInfo) => {\n   const config = {};\n\n   // xxx\n   return config;\n};\n\nexport const keys = '12345';\n")),(0,o.kt)("p",null,"Values defined with ",(0,o.kt)("inlineCode",{parentName:"p"},"export const")," are ignored."),(0,o.kt)("h3",{id:"3-mix-export-default-and-export-const"},"3. Mix export default and export const"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"The following is incorrect usage. ")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"export default {\n   keys: '12345',\n}\n\nexport const anotherKey = '54321';\n")),(0,o.kt)("p",null,"Configurations located later will be ignored."),(0,o.kt)("h3",{id:"4-export-mixed-with-others"},"4. Export= mixed with others"),(0,o.kt)("p",null,"When ",(0,o.kt)("inlineCode",{parentName:"p"},"export=")," is mixed, if there are other configurations later, the value of ",(0,o.kt)("inlineCode",{parentName:"p"},"export=")," will be ignored."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"export = {\n   a: 1\n}\nexport const b = 2;\n")),(0,o.kt)("p",null,"Compiled result:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"export const b = 2;\n")))}u.isMDXComponent=!0}}]);