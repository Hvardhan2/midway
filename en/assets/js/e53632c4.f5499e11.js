"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9902],{3905:(e,n,t)=>{t.d(n,{Zo:()=>s,kt:()=>f});var o=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,o,i=function(e,n){if(null==e)return{};var t,o,i={},a=Object.keys(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var c=o.createContext({}),p=function(e){var n=o.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},s=function(e){var n=p(e.components);return o.createElement(c.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},u=o.forwardRef((function(e,n){var t=e.components,i=e.mdxType,a=e.originalType,c=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),u=p(t),f=i,m=u["".concat(c,".").concat(f)]||u[f]||d[f]||a;return t?o.createElement(m,r(r({ref:n},s),{},{components:t})):o.createElement(m,r({ref:n},s))}));function f(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var a=t.length,r=new Array(a);r[0]=u;var l={};for(var c in n)hasOwnProperty.call(n,c)&&(l[c]=n[c]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var p=2;p<a;p++)r[p]=t[p];return o.createElement.apply(null,r)}return o.createElement.apply(null,t)}u.displayName="MDXCreateElement"},4706:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var o=t(7462),i=(t(7294),t(3905));const a={},r="Multi-environment configuration",l={unversionedId:"env_config",id:"env_config",title:"Multi-environment configuration",description:"Configuration is a common function, and different configuration information is often used in different environments.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/env_config.md",sourceDirName:".",slug:"/env_config",permalink:"/en/docs/env_config",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/env_config.md",tags:[],version:"current",frontMatter:{},sidebar:"common",previous:{title:"Operating environment",permalink:"/en/docs/environment"},next:{title:"Life cycle",permalink:"/en/docs/lifecycle"}},c={},p=[{value:"Business profile",id:"business-profile",level:2},{value:"Load business configuration",id:"load-business-configuration",level:2},{value:"1. Object form loading",id:"1-object-form-loading",level:3},{value:"2. Specify directory or file loading",id:"2-specify-directory-or-file-loading",level:3},{value:"Configuration format",id:"configuration-format",level:2},{value:"1. Object Form",id:"1-object-form",level:3},{value:"2. Function form",id:"2-function-form",level:3},{value:"Configuration definition",id:"configuration-definition",level:2},{value:"Configure load order",id:"configure-load-order",level:2},{value:"Configure merge rules",id:"configure-merge-rules",level:2},{value:"Get configuration",id:"get-configuration",level:2},{value:"Single configuration value",id:"single-configuration-value",level:3},{value:"Deep level configuration value",id:"deep-level-configuration-value",level:3},{value:"The entire configuration object",id:"the-entire-configuration-object",level:3},{value:"Modify configuration",id:"modify-configuration",level:2},{value:"Modification in Life Cycle",id:"modification-in-life-cycle",level:3},{value:"Add configuration in bootstrap",id:"add-configuration-in-bootstrap",level:3},{value:"Use API to add configuration",id:"use-api-to-add-configuration",level:3},{value:"Use environmental variables",id:"use-environmental-variables",level:2},{value:"Common errors",id:"common-errors",level:2},{value:"1. Get the value injected by @Config in the constructor (constructor)",id:"1-get-the-value-injected-by-config-in-the-constructor-constructor",level:3},{value:"2. Mixed use of callback and export writing",id:"2-mixed-use-of-callback-and-export-writing",level:3},{value:"3. mix export default and export const",id:"3-mix-export-default-and-export-const",level:3},{value:"4. export = mixed with other",id:"4-export--mixed-with-other",level:3}],s={toc:p};function d(e){let{components:n,...t}=e;return(0,i.kt)("wrapper",(0,o.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"multi-environment-configuration"},"Multi-environment configuration"),(0,i.kt)("p",null,"Configuration is a common function, and different configuration information is often used in different environments."),(0,i.kt)("p",null,"In this article, we will introduce how Midway loads business configurations for different environments."),(0,i.kt)("h2",{id:"business-profile"},"Business profile"),(0,i.kt)("p",null,"The framework provides extensible configuration functions, which can automatically merge the configurations of applications, frameworks, and components, and can maintain different configurations according to the environment."),(0,i.kt)("p",null,"You can customize the directory and put the configuration files of multiple environments in it. For example, the following common directory structures are used. For more information about the specific environment, see ",(0,i.kt)("a",{parentName:"p",href:"environment"},"Running environment"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\u279c  my_midway_app tree\n.\n\u251c\u2500\u2500 src\n\u2502   \u251c\u2500\u2500 config\n\u2502   \u2502   \u251c\u2500\u2500 config.default.ts\n\u2502   \u2502   \u251c\u2500\u2500 config.prod.ts\n\u2502   \u2502   \u251c\u2500\u2500 config.unittest.ts\n\u2502   \u2502   \u2514\u2500\u2500 config.local.ts\n\u2502   \u251c\u2500\u2500 interface.ts\n\u2502   \u2514\u2500\u2500 service\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 package.json\n\u2514\u2500\u2500 tsconfig.json\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"Config. default.ts")," is the default configuration file. All environments will load this configuration file and will generally be used as the default configuration file for the development environment."),(0,i.kt)("p",null,"The configuration is not ",(0,i.kt)("strong",{parentName:"p"},"required"),". You must add the required environment."),(0,i.kt)("h2",{id:"load-business-configuration"},"Load business configuration"),(0,i.kt)("p",null,"Then we can configure this file (directory) in ",(0,i.kt)("inlineCode",{parentName:"p"},"src/configuration.ts"),", and the framework will know to load it."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/decorator';\nimport { join } from 'path';\n\n@Configuration ({\n  importConfigs: [\n    join(__dirname, './config/')\n  ]\n})\nexport class ContainerLifeCycle {\n}\n")),(0,i.kt)("p",null,"Below we will introduce two ways to load the configuration."),(0,i.kt)("h3",{id:"1-object-form-loading"},"1. Object form loading"),(0,i.kt)("p",null,"Starting from Midway v3, we will introduce the standard object loading method as the configuration of the main push."),(0,i.kt)("p",null,"In some scenarios, such as single-file construction and other requirements that are not related to the directory structure, only this standard module loading method is supported to load the configuration."),(0,i.kt)("p",null,"The configuration files of each environment ",(0,i.kt)("strong",{parentName:"p"},"must be explicitly specified and added"),". Subsequent frames are merged based on the actual environment."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/decorator';\nimport { join } from 'path';\n\nimport * as DefaultConfig from './config/config.default';\nimport * as LocalConfig from './config/config.local';\n\n@Configuration ({\n  importConfigs: [\n    {\n      default: DefaultConfig\n      local: LocalConfig\n    }\n  ]\n})\nexport class ContainerLifeCycle {\n}\n")),(0,i.kt)("p",null,"The array in the ",(0,i.kt)("inlineCode",{parentName:"p"},"importConfigs")," passes configuration objects. The key of each object is the environment, and the value is the configuration value corresponding to the environment. midway loads the corresponding configuration according to the environment during startup."),(0,i.kt)("h3",{id:"2-specify-directory-or-file-loading"},"2. Specify directory or file loading"),(0,i.kt)("p",null,"Specifies that a directory is loaded. All ",(0,i.kt)("inlineCode",{parentName:"p"},"config.*.ts")," in the directory are scanned and loaded."),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("inlineCode",{parentName:"p"},"importConfigs")," here, only the files to be loaded are specified. In actual runtime, the current environment",(0,i.kt)("strong",{parentName:"p"}," will be "),"automatically selected to find the corresponding file suffix.")),(0,i.kt)("p",null,"The rules for the configuration file are:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},"You can specify a directory, the traditional ",(0,i.kt)("inlineCode",{parentName:"li"},"src/config")," directory is recommended, or you can specify a file"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li",start:2},(0,i.kt)("li",{parentName:"ol"},"file designation does not require TS suffix"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li",start:3},(0,i.kt)("li",{parentName:"ol"},"The configuration file ",(0,i.kt)("strong",{parentName:"li"},"must be explicitly specified and added"),".")))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Example: Specify a directory")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/decorator';\nimport { join } from 'path';\n\n@Configuration({\n  importConfigs: [\n    join(__dirname, './config/'),\n  ]\n})\nexport class ContainerLifeCycle {\n}\n")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Example: Specify a specific file")),(0,i.kt)("p",null,"When you manually specify a batch of files, an error will be reported if the file does not exist at this time."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/decorator';\nimport { join } from 'path';\n\n@Configuration({\n  importConfigs: [\n    join(__dirname, './config/config.default'),\n    join(__dirname, './config/config.local'),\n    join(__dirname, './config/custom.local')        // You can use custom naming, as long as the middle part has an environment\n  ]\n})\nexport class ContainerLifeCycle {\n}\n")),(0,i.kt)("p",null,"You can also use configurations outside the project, but use the absolute path and the ",(0,i.kt)("inlineCode",{parentName:"p"},"*.js")," suffix."),(0,i.kt)("p",null,"For example, the directory structure is as follows (note the ",(0,i.kt)("inlineCode",{parentName:"p"},"customConfig.default.js")," file):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"}," base-app\n \u251c\u2500\u2500 package.json\n \u251c\u2500\u2500 customConfig.default.js\n \u2514\u2500\u2500 src\n     \u251c\u2500\u2500 configuration.ts\n     \u2514\u2500\u2500 config\n         \u2514\u2500\u2500 config.default.ts\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/decorator';\nimport { join } from 'path';\n\n@Configuration ({\n  importConfigs: [\n    join(__dirname, './config/')\n    join(__dirname, '../customConfig.default')\n  ]\n})\nexport class ContainerLifeCycle {\n}\n")),(0,i.kt)("h2",{id:"configuration-format"},"Configuration format"),(0,i.kt)("p",null,"Midway provides a ",(0,i.kt)("inlineCode",{parentName:"p"},"MidwayConfig")," definition. Whenever a component is turned on (",(0,i.kt)("inlineCode",{parentName:"p"},"imports")," in ",(0,i.kt)("inlineCode",{parentName:"p"},"configuration.ts")," ), the ",(0,i.kt)("inlineCode",{parentName:"p"},"MidwayConfig")," will automatically include the configuration definition of the component."),(0,i.kt)("p",null,"Configurations can be exported in two formats."),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Through our practice, exporting objects will be simpler and more friendly, and many wrong usages can be avoided."),(0,i.kt)("p",{parentName:"admonition"},"The configuration of the components will be documented in this format.")),(0,i.kt)("h3",{id:"1-object-form"},"1. Object Form"),(0,i.kt)("p",null,"The configuration file format is object, for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { MidwayConfig } from '@midwayjs/core';\n\nexport default {\n  keys: '1639994056460_8009',\n  koa: {\n    port: 7001,\n  },\n} as MidwayConfig;\n")),(0,i.kt)("h3",{id:"2-function-form"},"2. Function form"),(0,i.kt)("p",null,"The configuration file is a function with ",(0,i.kt)("inlineCode",{parentName:"p"},"appInfo")," parameters. In the form of this return method, it will be automatically executed during the runtime, merging the return values into the complete configuration object."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nimport { MidwayAppInfo, MidwayConfig } from '@midwayjs/core';\n\nexport default (appInfo: MidwayAppInfo): MidwayConfig => {\n  return {\n    keys: '1639994056460_8009',\n    koa: {\n      port: 7001\n    },\n    view: {\n      root: path.join(appInfo.appDir, 'view')\n    },\n  };\n}\n\n")),(0,i.kt)("p",null,"The parameter of this function is of ",(0,i.kt)("inlineCode",{parentName:"p"},"MidwayAppInfo")," type and the value is the following."),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},(0,i.kt)("strong",{parentName:"th"},"appInfo")),(0,i.kt)("th",{parentName:"tr",align:null},(0,i.kt)("strong",{parentName:"th"},"Description")))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"pkg"),(0,i.kt)("td",{parentName:"tr",align:null},"package.json")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"name"),(0,i.kt)("td",{parentName:"tr",align:null},"Application name, same as pkg.name")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"baseDir"),(0,i.kt)("td",{parentName:"tr",align:null},"The src (locally developed) or dist (after online) directory of the application code")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"appDir"),(0,i.kt)("td",{parentName:"tr",align:null},"Directory of application code")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"HOME"),(0,i.kt)("td",{parentName:"tr",align:null},"The user directory, for example, the admin account is/home/admin.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"root"),(0,i.kt)("td",{parentName:"tr",align:null},"The root directory of the application is only baseDir in local and unittest environments, and the others are HOME.")))),(0,i.kt)("h2",{id:"configuration-definition"},"Configuration definition"),(0,i.kt)("p",null,"Midway provides ",(0,i.kt)("inlineCode",{parentName:"p"},"MidwayConfig")," as a unified configuration item definition, and all components merge the definition into this configuration item definition."),(0,i.kt)("p",null,"To do this, please use the format recommended by the document as much as possible to achieve the best effect."),(0,i.kt)("p",null,"Whenever a new component is enabled, the configuration definition will automatically add the configuration items of the component. Through this behavior, you can also check whether a component is enabled in disguise."),(0,i.kt)("p",null,"For example, we have enabled the effect of the view component."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://img.alicdn.com/imgextra/i2/O1CN013sHGlA1o3uQ4Pg0nO_!!6000000005170-2-tps-1416-572.png",alt:null})),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Why not use the normal key export form and use the object?"),(0,i.kt)("ol",{parentName:"admonition"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"If the user does not understand the configuration items, he still needs to check the document to understand the meaning of each item. Except that the first layer has a certain prompt function, the later level prompts have no obvious efficiency improvement.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"The form of key export has no advantage in the deep structure.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Key export may be duplicated, but there will be no warning or error at the code level, which is difficult to troubleshoot. This object form is relatively friendly.")))),(0,i.kt)("h2",{id:"configure-load-order"},"Configure load order"),(0,i.kt)("p",null,"There is a priority in the configuration (application code> component), and the priority will be higher relative to this operating environment."),(0,i.kt)("p",null,"For example, the loading sequence of a configuration in the prod environment is as follows, and the subsequent loading will overwrite the previous configuration with the same name."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"-> component config.default.ts\n-> apply config.default.ts\n-> component config.prod.ts\n-> apply config.prod.ts\n")),(0,i.kt)("h2",{id:"configure-merge-rules"},"Configure merge rules"),(0,i.kt)("p",null,"By default, the ",(0,i.kt)("inlineCode",{parentName:"p"},"**/config.defaut.ts")," file and the ",(0,i.kt)("inlineCode",{parentName:"p"},"**/config.{environment}.ts")," file are loaded."),(0,i.kt)("p",null,"For example, the following code will find the ",(0,i.kt)("inlineCode",{parentName:"p"},"config.default.*")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"config.local.*")," files in the ",(0,i.kt)("inlineCode",{parentName:"p"},"local")," environment. If the file is in other environments, only ",(0,i.kt)("inlineCode",{parentName:"p"},"config.default.*")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"config.{current environment}.*")," will be found. If the file does not exist, it will not be loaded or an error will be reported."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/decorator';\nimport { join } from 'path';\n\n@Configuration({\n  importConfigs: [\n    join(__dirname, './config/'),\n  ]\n})\nexport class ContainerLifeCycle {\n}\n")),(0,i.kt)("p",null,"In order to be forward compatible, we have done some processing on configuration reading for some special environments. The value of the environment here refers to the ",(0,i.kt)("a",{parentName:"p",href:"environment#AxjGQ"},"result")," obtained from the combination of ",(0,i.kt)("inlineCode",{parentName:"p"},"NODE_ENV")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"MIDWAY_SERVER_ENV")," values."),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},(0,i.kt)("strong",{parentName:"th"},"Environment Value")),(0,i.kt)("th",{parentName:"tr",align:null},(0,i.kt)("strong",{parentName:"th"},"Read configuration file")))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"prod"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("em",{parentName:"td"},".default.ts + "),".prod.ts")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"production"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("em",{parentName:"td"},".default.ts + "),".production.ts + *.prod.ts")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"unittest"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("em",{parentName:"td"},".default.ts + "),".unittest.ts")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"test"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("em",{parentName:"td"},".default.ts + "),".test.ts + *.unittest.ts")))),(0,i.kt)("p",null,"Except for the above table, the rest are values of ",(0,i.kt)("inlineCode",{parentName:"p"},"*.default.ts + *.{current environment}.ts"),"."),(0,i.kt)("p",null,"In addition, the configured merge uses the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/eggjs/extend2"},"extend2")," module for deep copy, ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/eggjs/extend2"},"extend2")," fork from ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/justmoon/node-extend"},"extend"),", and there will be differences in array processing."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const a = {\n  arr: [ 1, 2 ],\n};\nconst b = {\n  arr: [ 3 ],\n};\nextend(true, a, b);\n// => { arr: [ 3 ] }\n")),(0,i.kt)("p",null,"According to the above example, the framework directly covers the array instead of merging."),(0,i.kt)("h2",{id:"get-configuration"},"Get configuration"),(0,i.kt)("p",null,"Midway saves all the configurations in the internal configuration service. The entire structure is an object. When using the Midway service code, use the ",(0,i.kt)("inlineCode",{parentName:"p"},"@Config")," decorator to inject the configuration."),(0,i.kt)("h3",{id:"single-configuration-value"},"Single configuration value"),(0,i.kt)("p",null,"By default, it is obtained from the configuration object based on the string parameter value of the decorator."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Config } from '@midwayjs/decorator';\n\nexport class IndexHandler {\n\n  @Config('userService')\n  userConfig;\n\n  async handler() {\n    console.log(this.userConfig);  // { appname: 'test'}\n  }\n}\n")),(0,i.kt)("h3",{id:"deep-level-configuration-value"},"Deep level configuration value"),(0,i.kt)("p",null,"If the value of the configuration object is deep in the object, it can be obtained in Cascade."),(0,i.kt)("p",null,"For example, the data source is:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "userService ": {\n    "appname ": {\n      "test ": {\n        "data": "xxx"\n      }\n    }\n  }\n}\n')),(0,i.kt)("p",null,"You can write complex fetch expressions to fetch values, as shown in the following example."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Config } from '@midwayjs/decorator';\n\nexport class IndexHandler {\n\n  @Config('userService.appname.test.data')\n  data;\n\n  async handler() {\n    console.log(this.data);  // xxx\n  }\n}\n")),(0,i.kt)("h3",{id:"the-entire-configuration-object"},"The entire configuration object"),(0,i.kt)("p",null,"You can also use the ",(0,i.kt)("inlineCode",{parentName:"p"},"ALL")," attribute to obtain the entire configured object."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Config, ALL } from '@midwayjs/decorator';\n\nexport class IndexHandler {\n\n  @Config(ALL)\n  allConfig;\n\n  async handler() {\n    console.log(this.allConfig);  // { userService: { appname: 'test'}}\n  }\n}\n")),(0,i.kt)("h2",{id:"modify-configuration"},"Modify configuration"),(0,i.kt)("p",null,"In the coding process, we have some places that can dynamically modify the configuration for different scenarios."),(0,i.kt)("h3",{id:"modification-in-life-cycle"},"Modification in Life Cycle"),(0,i.kt)("p",null,"midway adds an asynchronous configuration loading lifecycle that can be executed after the configuration is loaded."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/decorator';\nimport { IMidwayContainer } from '@midwayjs/core';\nimport { join } from 'path';\nImport {RemoteConfigService } from '../service/remote'; // Custom Get Remote Configuration Service\n\n@Configuration ({\n  importConfigs: [\n    join(__dirname, './config/')\n  ]\n})\nexport class ContainerLifeCycle {\n\n  async onConfigLoad(container: IMidwayContainer) {\n    // Here you can modify the global configuration\n    const remoteConfigService = await container.getAsync(RemoteConfigService);\n    const remoteConfig = await remoteConfigService.getData();\n\n    // The return value here will be merged with the global config\n    return {\n        data: remoteConfig\n    };\n  }\n}\n")),(0,i.kt)("p",null,"Note that the ",(0,i.kt)("inlineCode",{parentName:"p"},"onConfigLoad")," lifecycle is executed after the egg plug-in (if any) is initialized, so it cannot be used to override the configuration used by the egg plug-in."),(0,i.kt)("h3",{id:"add-configuration-in-bootstrap"},"Add configuration in bootstrap"),(0,i.kt)("p",null,"You can add configuration before starting the code."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// bootstrap.js\nconst { Bootstrap } = require('@midwayjs/bootstrap');\nBootstrap\n  .configure({\n    globalConfig: {\n      default: {\n        keys: 'abcde',\n        koa: {\n          port: 7001\n        }\n      },\n      unittest: {\n        koa: {\n          port: null\n        }\n      }\n    }\n  })\n  .run();\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"configure")," method can pass a ",(0,i.kt)("inlineCode",{parentName:"p"},"globalConfig")," attribute, and can pass a global configuration before the application starts. The structure is consistent with the configuration of the object form to distinguish the environment."),(0,i.kt)("h3",{id:"use-api-to-add-configuration"},"Use API to add configuration"),(0,i.kt)("p",null,"You can use the ",(0,i.kt)("a",{parentName:"p",href:"./built_in_service#midwayconfigservice"},"API")," provided by midway to modify the configuration in other scenarios."),(0,i.kt)("h2",{id:"use-environmental-variables"},"Use environmental variables"),(0,i.kt)("p",null,"The community has some libraries, such as ",(0,i.kt)("inlineCode",{parentName:"p"},"dotenv"),", which can load ",(0,i.kt)("inlineCode",{parentName:"p"},".env")," files and inject them into the environment, so as to put some keys in the environment, which can be directly used in Midway."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i dotenv --save\n")),(0,i.kt)("p",null,"We can initialize in entry points like ",(0,i.kt)("inlineCode",{parentName:"p"},"bootstrap.js")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"configuration")," ."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"OSS_SECRET = 12345\nOSS_ACCESSKEY = 54321\n")),(0,i.kt)("p",null,"We can initialize in the portal, such as ",(0,i.kt)("inlineCode",{parentName:"p"},"bootstrap.js")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"configuration"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Configuration } from '@midwayjs/decorator';\nimport * as dotenv from 'dotenv';\n\n// load .env file in process.cwd\ndotenv.config();\n\n@Configuration ({\n  //...\n})\nexport class AutoConfiguration {\n  async onReady(container) {\n\n  }\n}\n\n")),(0,i.kt)("p",null,"We can use it in the environment configuration."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\n\nexport const oss = {\n  accessKey: process.env.OSS_ACCESSKEY, // 54321\n  secret: process.env.OSS_SECRET // 12345\n}\n")),(0,i.kt)("h2",{id:"common-errors"},"Common errors"),(0,i.kt)("p",null,"There are many possibilities that the configuration does not take effect, and the troubleshooting ideas are as follows:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},"Check whether ",(0,i.kt)("inlineCode",{parentName:"li"},"importConfigs")," related files or directories are explicitly configured in the configuration file"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li",start:2},(0,i.kt)("li",{parentName:"ol"},"Check whether the environment in which the application is started is consistent with the configuration file. For example, the configuration of prod will definitely not appear in local"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("ol",{parentName:"li",start:3},(0,i.kt)("li",{parentName:"ol"},"Check whether ordinary export and method callback export are mixed, such as the following mixed use")))),(0,i.kt)("h3",{id:"1-get-the-value-injected-by-config-in-the-constructor-constructor"},"1. Get the value injected by @Config in the constructor (constructor)"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Please do not get the attribute injected by ",(0,i.kt)("inlineCode",{parentName:"strong"},"@Config()")," in the constructor"),", which will make the result undefined. The reason is that the properties injected by the decorator are assigned only after the instance is created (new). In this case, use the ",(0,i.kt)("inlineCode",{parentName:"p"},"@Init")," decorator."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"@Provide()\nexport class UserService {\n\n  @Config('redisConfig')\n  redisConfig;\n\n  constructor() {\n    console.log(this.redisConfig); // undefined\n  }\n\n  @Init()\n  async initMethod() {\n    console.log(this.redisConfig); // has value\n  }\n\n}\n")),(0,i.kt)("h3",{id:"2-mixed-use-of-callback-and-export-writing"},"2. Mixed use of callback and export writing"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"The following is the wrong usage.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"export default (appInfo) => {\n  const config = {};\n\n  // xxx\n  return config;\n};\n\nexport const keys = '12345';\n")),(0,i.kt)("p",null,"The value defined by ",(0,i.kt)("inlineCode",{parentName:"p"},"export const")," is ignored."),(0,i.kt)("h3",{id:"3-mix-export-default-and-export-const"},"3. mix export default and export const"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"The following is the wrong usage.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"export default {\n  keys: '12345',\n}\n\nexport const anotherKey = '54321';\n")),(0,i.kt)("p",null,"The following configuration will be ignored."),(0,i.kt)("h3",{id:"4-export--mixed-with-other"},"4. export = mixed with other"),(0,i.kt)("p",null,"If the ",(0,i.kt)("inlineCode",{parentName:"p"},"export =")," parameter is mixed, the value of the ",(0,i.kt)("inlineCode",{parentName:"p"},"export =")," parameter is ignored."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"export = {\n  a: 1\n}\nexport const b = 2;\n")),(0,i.kt)("p",null,"Compiled results:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"export const b = 2;\n")))}d.isMDXComponent=!0}}]);