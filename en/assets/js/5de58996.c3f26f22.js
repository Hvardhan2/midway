"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[89456],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),m=r,h=d["".concat(l,".").concat(m)]||d[m]||u[m]||i;return n?a.createElement(h,o(o({ref:t},p),{},{components:n})):a.createElement(h,o({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},87615:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var a=n(87462),r=(n(67294),n(3905));const i={},o="Data subscription",s={unversionedId:"data_listener",id:"data_listener",title:"Data subscription",description:'In some scenarios, we want to subscribe to a certain data and update it after a period of time. This kind of subscription-like method, which we call "data subscription", common remote data acquisition, etc., can apply this mode.',source:"@site/i18n/en/docusaurus-plugin-content-docs/current/data_listener.md",sourceDirName:".",slug:"/data_listener",permalink:"/en/docs/data_listener",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/data_listener.md",tags:[],version:"current",frontMatter:{},sidebar:"common",previous:{title:"Service factory",permalink:"/en/docs/service_factory"},next:{title:"Data source management",permalink:"/en/docs/data_source"}},l={},c=[{value:"Realize data subscription",id:"realize-data-subscription",level:2},{value:"Use data subscription",id:"use-data-subscription",level:2}],p={toc:c},d="wrapper";function u(e){let{components:t,...n}=e;return(0,r.kt)(d,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"data-subscription"},"Data subscription"),(0,r.kt)("p",null,'In some scenarios, we want to subscribe to a certain data and update it after a period of time. This kind of subscription-like method, which we call "data subscription", common remote data acquisition, etc., can apply this mode.'),(0,r.kt)("p",null,"Midway provides ",(0,r.kt)("inlineCode",{parentName:"p"},"DataListener")," abstractions to easily create code for this pattern."),(0,r.kt)("h2",{id:"realize-data-subscription"},"Realize data subscription"),(0,r.kt)("p",null,"Let's take a simple ",(0,r.kt)("strong",{parentName:"p"},"memory data update")," requirement as an example."),(0,r.kt)("p",null,"Data subscription is also a common class in midway. For example, we can also put it in ",(0,r.kt)("inlineCode",{parentName:"p"},"src/listener/memory.listner.ts"),"."),(0,r.kt)("p",null,"We only need to inherit the built-in ",(0,r.kt)("inlineCode",{parentName:"p"},"DataListener")," class, and at the same time, the general data subscription class is singleton."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"DataListener")," contains a generic type, you need to declare the data type returned by the data subscription."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/listener/memory.listner.ts\nimport { DataListener, Provide, Scope, ScopeEnum } from '@midwayjs/core';\n\n@Provide()\n@Scope(ScopeEnum.Singleton)\nexport class MemoryDataListener extends DataListener<string> {\n  // Initialize data\n  initData() {\n    return 'hello' + Date.now();\n  }\n\n  // Update data\n  onData(setData) {\n    setInterval(() => {\n      setData('hello' + Date.now());\n    }, 1000);\n  }\n}\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"DataListener")," class has two methods that must be implemented:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Initialization method of ",(0,r.kt)("inlineCode",{parentName:"li"},"initData")," data"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"onData"))),(0,r.kt)("p",null,"In the example, we initialize the data and implement the data update method. Every 1 second, we use ",(0,r.kt)("inlineCode",{parentName:"p"},"setData")," to update the built-in data."),(0,r.kt)("p",null,"In addition, most data subscriptions use timers or other external SDKs. We need to consider shutting down and cleaning up resources."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"destroyListener")," methods are provided in the code to handle."),(0,r.kt)("p",null,"For example, in the above sample code, we need to turn off the timer."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/listener/memory.listner.ts\nimport { DataListener, Provide, Scope, ScopeEnum } from '@midwayjs/core';\n\n@Provide()\n@Scope(ScopeEnum.Singleton)\nexport class MemoryDataListener extends DataListener<string> {\n  private intervalHandler;\n\n  // Initialize data\n  initData() {\n    return 'hello' + Date.now();\n  }\n\n  // Update data\n  onData(setData) {\n    this.intervalHandler = setInterval(() => {\n      setData('hello' + Date.now());\n    }, 1000);\n  }\n\n  // Clean up resources\n  async destroyListener() {\n    // Turn off timer\n    clearInterval(this.intervalHandler);\n    // Other cleanup, close sdk, etc\n  }\n\n}\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"initData")," method above can fetch data asynchronously."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// ...\nexport class MemoryDataListener extends DataListener<string> {\n  async initData() {\n    // ...\n  }\n}\n")),(0,r.kt)("h2",{id:"use-data-subscription"},"Use data subscription"),(0,r.kt)("p",null,"We can use it in any code to obtain the current data through ",(0,r.kt)("inlineCode",{parentName:"p"},"getData")," methods in the business without considering the data changes."),(0,r.kt)("p",null,"For example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide, Inject } from '@midwayjs/core';\nimport { MemoryDataListener } from '../listener/memory.listner.ts';\n\n@Provide()\nexport class UserService {\n\n  @Inject()\n  memoryDataListener: MemoryDataListener;\n\n  async getUserHelloData() {\n    const helloData = this.memoryDataListener.getData();\n    // helloData => helloxxxxxxxx\n    // ...\n  }\n}\n")),(0,r.kt)("p",null,"The data subscription mode can easily hide the changed data in the common class, and reveal the unchanged API, making the standard business code in the logic and process of the concise."))}u.isMDXComponent=!0}}]);