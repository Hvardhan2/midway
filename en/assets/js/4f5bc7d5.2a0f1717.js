"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[62766],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(n),m=i,f=d["".concat(s,".").concat(m)]||d[m]||u[m]||o;return n?a.createElement(f,r(r({ref:t},c),{},{components:n})):a.createElement(f,r({ref:t},c))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var p=2;p<o;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},70643:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var a=n(87462),i=(n(67294),n(3905));const o={},r="Egg application migration",l={unversionedId:"serverless/migrate_egg",id:"serverless/migrate_egg",title:"Egg application migration",description:"Midway Serverless provides a general application migration scheme, which can publish the original application to the function platform without modifying the code as much as possible. with this solution, you can migrate the original egg application to the function platform for hosting as quickly and simply as possible, and enjoy the elastic bonus of the cloud native era.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/serverless/migrate_egg.md",sourceDirName:"serverless",slug:"/serverless/migrate_egg",permalink:"/en/docs/serverless/migrate_egg",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/serverless/migrate_egg.md",tags:[],version:"current",frontMatter:{},sidebar:"serverless",previous:{title:"Express application migration",permalink:"/en/docs/serverless/migrate_express"},next:{title:"Serverless trigger POST case differences",permalink:"/en/docs/serverless/serverless_post_difference"}},s={},p=[{value:"Use",id:"use",level:2},{value:"TS compilation",id:"ts-compilation",level:2},{value:"Deployment",id:"deployment",level:2},{value:"Default",id:"default",level:2},{value:"Modify the function name of the default deployment.",id:"modify-the-function-name-of-the-default-deployment",level:3},{value:"Egg default configuration of migration scheme",id:"egg-default-configuration-of-migration-scheme",level:3},{value:"ariyun",id:"ariyun",level:3},{value:"Tencent cloud",id:"tencent-cloud",level:3},{value:"Some restrictions",id:"some-restrictions",level:2}],c={toc:p};function u(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"egg-application-migration"},"Egg application migration"),(0,i.kt)("p",null,"Midway Serverless provides a general application migration scheme, which can publish the original application to the function platform without modifying the code as much as possible. with this solution, you can migrate the original egg application to the function platform for hosting as quickly and simply as possible, and enjoy the elastic bonus of the cloud native era."),(0,i.kt)("h2",{id:"use"},"Use"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"f.yml")," file is added to the root directory of the code. The simplest content is as follows."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"Service: Name of My-egg-Demo## Application published to cloud platform\n\nprovider:\n  name: aliyun      ## cloud platform, aliyun,tencent, etc\n\ndeployType:\n  type: egg             ## Deployed application type\n  version: 3.0.0\n\npackage:\n  include:\n    -public             ## If there is a static file directory, it will be automatically copied here.\n  exclude:\n    -package-lock.json ## Ignore package-lock.json files\n\ncustom:\n  customDomain:\n    domainName: auto ## automatically generates domain name\n")),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},"Sometimes package-lock.json files will cause the deployment package to be too large (enter dev dependencies).")),(0,i.kt)("h2",{id:"ts-compilation"},"TS compilation"),(0,i.kt)("p",null,"If it is a egg-ts project, you can use the release hook provided by us to automatically perform compilation at the time of release. The configuration in ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," is as follows."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "name": "xxxxxx ",\n  "version": "xxxx ",\n  .....\n  "midway-integration": {\n    "lifecycle": {\n      "before:package:cleanup": "npm run tsc"\n    }\n  }\n}\n')),(0,i.kt)("h2",{id:"deployment"},"Deployment"),(0,i.kt)("p",null,"In the ",(0,i.kt)("inlineCode",{parentName:"p"},"package.json")," configuration Scripts script and dev dependency ",(0,i.kt)("inlineCode",{parentName:"p"},"@midwayjs/cli"),", execute ",(0,i.kt)("inlineCode",{parentName:"p"},"npm run deploy"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "devDependencies": {\n    "@midwayjs/cli": "^1.2.36"\n    ...\n  },\n  "scripts": {\n    "deploy": "midway-bin deploy ",\n    ...\n  }\n}\n')),(0,i.kt)("p",null,"Or use a different npm package to accelerate."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'{\n  "scripts": {\n    "deploy": "midway-bin deploy --npm=cnpm ",\n    ...\n  }\n}\n')),(0,i.kt)("p",null,"You can also execute commands separately."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$npx midway-bin deploy ## deploy by npm\n$npx midway-bin deploy --npm=cnpm ## deploy by cnpm\n")),(0,i.kt)("h2",{id:"default"},"Default"),(0,i.kt)("h3",{id:"modify-the-function-name-of-the-default-deployment"},"Modify the function name of the default deployment."),(0,i.kt)("p",null,"You can use the name field."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"service: name of my-demo ## application published to cloud platform\n\nprovider:\n  name: aliyun ## cloud platform, aliyun,tencent, etc\n\ndeployType:\n  type: egg\n  version: 3.0.0\n  Name: app_idx ## function name\n")),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},"aggregation fields do not take effect when using deployType.")),(0,i.kt)("h3",{id:"egg-default-configuration-of-migration-scheme"},"Egg default configuration of migration scheme"),(0,i.kt)("p",null,"In the current migration scheme, some default configurations are added for better operation in the function system. ",(0,i.kt)("strong",{parentName:"p"},"In general, you do not need to modify"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// config.default\nconst os = require('os');\nexports.logger = {\n  dir: os.tmpdir()\n};\n\nexports.rundir = os.tmpdir();\n\nexports.static = {\n  buffer: true\n};\n")),(0,i.kt)("p",null,"Since the function environment disk is not writable, we adjusted the default log directories to temporary directories."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-typescript"},"// plugin\n\n'use strict';\n\nexports.i18n = false;\nexports.watcher = false;\nexports.development = false;\nexports.logrotator = false;\nexports.schedule = false;\nexports.static = false;\n")),(0,i.kt)("p",null,"Different from the default egg, the static plug-in is disabled by default. If the ",(0,i.kt)("inlineCode",{parentName:"p"},"app/public")," directory is not available by default, the plug-in is created when it is started. An error is reported because the server disk is not writable."),(0,i.kt)("p",null,"If you need a static plug-in, ",(0,i.kt)("strong",{parentName:"p"},"open it manually")," and ",(0,i.kt)("strong",{parentName:"p"},"make sure that the")," ",(0,i.kt)("inlineCode",{parentName:"p"},"app/public")," or the corresponding directory exists."),(0,i.kt)("p",null,"If the ",(0,i.kt)("inlineCode",{parentName:"p"},"public")," directory is in the root directory, configure the ",(0,i.kt)("inlineCode",{parentName:"p"},"package.include")," field in ",(0,i.kt)("inlineCode",{parentName:"p"},"f.yml"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"package:\n  include:\n    -public ## If there is a static file directory, it will be automatically copied here.\n  exclude:\n    -package-lock.json ## Ignore package-lock.json files\n")),(0,i.kt)("h3",{id:"ariyun"},"ariyun"),(0,i.kt)("p",null,"By default, it is published as an http trigger. If you need an API gateway, you can modify and configure the functions structure in the format of f.yml. At the same time, configure the route ",(0,i.kt)("inlineCode",{parentName:"p"},"/*")," at the API gateway to transfer to this function."),(0,i.kt)("h3",{id:"tencent-cloud"},"Tencent cloud"),(0,i.kt)("p",null,"By default, it is published as an API gateway trigger and the gateway route is automatically configured."),(0,i.kt)("h2",{id:"some-restrictions"},"Some restrictions"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"egg-socketio, etc. Not supported"),(0,i.kt)("li",{parentName:"ul"},"It does not support the ability that the gateway cannot support such as file upload.")))}u.isMDXComponent=!0}}]);