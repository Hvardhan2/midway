"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4599],{3905:function(t,e,n){n.d(e,{Zo:function(){return m},kt:function(){return u}});var r=n(7294);function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function s(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function o(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?s(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function i(t,e){if(null==t)return{};var n,r,a=function(t,e){if(null==t)return{};var n,r,a={},s=Object.keys(t);for(r=0;r<s.length;r++)n=s[r],e.indexOf(n)>=0||(a[n]=t[n]);return a}(t,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(r=0;r<s.length;r++)n=s[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(a[n]=t[n])}return a}var p=r.createContext({}),l=function(t){var e=r.useContext(p),n=e;return t&&(n="function"==typeof t?t(e):o(o({},e),t)),n},m=function(t){var e=l(t.components);return r.createElement(p.Provider,{value:e},t.children)},d={inlineCode:"code",wrapper:function(t){var e=t.children;return r.createElement(r.Fragment,{},e)}},c=r.forwardRef((function(t,e){var n=t.components,a=t.mdxType,s=t.originalType,p=t.parentName,m=i(t,["components","mdxType","originalType","parentName"]),c=l(n),u=a,g=c["".concat(p,".").concat(u)]||c[u]||d[u]||s;return n?r.createElement(g,o(o({ref:e},m),{},{components:n})):r.createElement(g,o({ref:e},m))}));function u(t,e){var n=arguments,a=e&&e.mdxType;if("string"==typeof t||a){var s=n.length,o=new Array(s);o[0]=c;var i={};for(var p in e)hasOwnProperty.call(e,p)&&(i[p]=e[p]);i.originalType=t,i.mdxType="string"==typeof t?t:a,o[1]=i;for(var l=2;l<s;l++)o[l]=n[l];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}c.displayName="MDXCreateElement"},3035:function(t,e,n){n.r(e),n.d(e,{assets:function(){return m},contentTitle:function(){return p},default:function(){return u},frontMatter:function(){return i},metadata:function(){return l},toc:function(){return d}});var r=n(7462),a=n(3366),s=(n(7294),n(3905)),o=["components"],i={},p="\u8eab\u4efd\u9a8c\u8bc1",l={unversionedId:"extensions/passport",id:"extensions/passport",title:"\u8eab\u4efd\u9a8c\u8bc1",description:"\u8eab\u4efd\u9a8c\u8bc1\u662f\u5927\u591a\u6570Web\u5e94\u7528\u7a0b\u5e8f\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\u3002\u56e0\u6b64 Midway \u5c01\u88c5\u4e86\u76ee\u524d Nodejs \u4e2d\u6700\u6d41\u884c\u7684 Passport \u5e93\u3002",source:"@site/docs/extensions/passport.md",sourceDirName:"extensions",slug:"/extensions/passport",permalink:"/docs/extensions/passport",editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/extensions/passport.md",tags:[],version:"current",frontMatter:{},sidebar:"component",previous:{title:"\u6587\u4ef6\u4e0a\u4f20",permalink:"/docs/extensions/upload"},next:{title:"\u89d2\u8272\u9274\u6743",permalink:"/docs/extensions/casbin"}},m={},d=[{value:"\u4e00\u4e9b\u6982\u5ff5",id:"\u4e00\u4e9b\u6982\u5ff5",level:2},{value:"\u5b89\u88c5\u4f9d\u8d56",id:"\u5b89\u88c5\u4f9d\u8d56",level:2},{value:"\u542f\u7528\u7ec4\u4ef6",id:"\u542f\u7528\u7ec4\u4ef6",level:2},{value:"\u7b56\u7565\u793a\u4f8b",id:"\u7b56\u7565\u793a\u4f8b",level:2},{value:"\u793a\u4f8b\uff1a\u672c\u5730\u7b56\u7565",id:"\u793a\u4f8b\u672c\u5730\u7b56\u7565",level:3},{value:"\u793a\u4f8b\uff1aJwt \u7b56\u7565",id:"\u793a\u4f8bjwt-\u7b56\u7565",level:3},{value:"\u81ea\u5b9a\u4e49\u5176\u4ed6\u7b56\u7565",id:"\u81ea\u5b9a\u4e49\u5176\u4ed6\u7b56\u7565",level:2},{value:"\u7b56\u7565\u9009\u9879",id:"\u7b56\u7565\u9009\u9879",level:2},{value:"\u5e38\u89c1\u95ee\u9898",id:"\u5e38\u89c1\u95ee\u9898",level:2},{value:"1\u3001Failed to serialize user into session",id:"1failed-to-serialize-user-into-session",level:3}],c={toc:d};function u(t){var e=t.components,n=(0,a.Z)(t,o);return(0,s.kt)("wrapper",(0,r.Z)({},c,n,{components:e,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"\u8eab\u4efd\u9a8c\u8bc1"},"\u8eab\u4efd\u9a8c\u8bc1"),(0,s.kt)("p",null,"\u8eab\u4efd\u9a8c\u8bc1\u662f\u5927\u591a\u6570Web\u5e94\u7528\u7a0b\u5e8f\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\u3002\u56e0\u6b64 Midway \u5c01\u88c5\u4e86\u76ee\u524d Nodejs \u4e2d\u6700\u6d41\u884c\u7684 Passport \u5e93\u3002"),(0,s.kt)("p",null,"\u76f8\u5173\u4fe1\u606f\uff1a"),(0,s.kt)("table",null,(0,s.kt)("thead",{parentName:"table"},(0,s.kt)("tr",{parentName:"thead"},(0,s.kt)("th",{parentName:"tr",align:null},"web \u652f\u6301\u60c5\u51b5"),(0,s.kt)("th",{parentName:"tr",align:null}))),(0,s.kt)("tbody",{parentName:"table"},(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:null},"@midwayjs/koa"),(0,s.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:null},"@midwayjs/faas"),(0,s.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:null},"@midwayjs/web"),(0,s.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:null},"@midwayjs/express"),(0,s.kt)("td",{parentName:"tr",align:null},"\u2705")))),(0,s.kt)("p",null,"\u4ece v3.4.0 \u5f00\u59cb Midway \u81ea\u884c\u7ef4\u62a4 passport\uff0c\u5c06\u4e0d\u518d\u9700\u8981\u5f15\u5165\u793e\u533a\u5305\u548c\u7c7b\u578b\u5305\u3002"),(0,s.kt)("h2",{id:"\u4e00\u4e9b\u6982\u5ff5"},"\u4e00\u4e9b\u6982\u5ff5"),(0,s.kt)("p",null,"passport \u662f\u793e\u533a\u4f7f\u7528\u8f83\u591a\u7684\u8eab\u4efd\u9a8c\u8bc1\u5e93\uff0c\u901a\u8fc7\u79f0\u4e3a\u7b56\u7565\u7684\u53ef\u6269\u5c55\u63d2\u4ef6\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\u8bf7\u6c42\u3002Passport \u4e0d\u6302\u8f7d\u8def\u7531\u6216\u5047\u8bbe\u4efb\u4f55\u7279\u5b9a\u7684\u6570\u636e\u5e93\uff0c\u8fd9\u6700\u5927\u9650\u5ea6\u5730\u63d0\u9ad8\u4e86\u7075\u6d3b\u6027\u5e76\u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u505a\u51fa\u5e94\u7528\u7a0b\u5e8f\u7ea7\u522b\u7684\u51b3\u7b56\u3002"),(0,s.kt)("p",null,"\u5b83\u672c\u8eab\u5305\u542b\u51e0\u4e2a\u90e8\u5206\uff1a"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"1\u3001\u9a8c\u8bc1\u7684\u7b56\u7565\uff0c\u6bd4\u5982 jwt \u9a8c\u8bc1\uff0cgithub \u9a8c\u8bc1\uff0coauth \u9a8c\u8bc1\u7b49\uff0cpassport \u6700\u4e3a\u4e30\u5bcc\u7684\u4e5f\u662f\u8fd9\u5757"),(0,s.kt)("li",{parentName:"ul"},"2\u3001\u6267\u884c\u7b56\u7565\u4e4b\u540e\uff0c\u4e2d\u95f4\u4ef6\u7684\u903b\u8f91\u5904\u7406\u548c\u914d\u7f6e\uff0c\u6bd4\u5982\u6210\u529f\u6216\u8005\u5931\u8d25\u540e\u7684\u8df3\u8f6c\uff0c\u62a5\u9519\u7b49")),(0,s.kt)("h2",{id:"\u5b89\u88c5\u4f9d\u8d56"},"\u5b89\u88c5\u4f9d\u8d56"),(0,s.kt)("p",null,"\u5b89\u88c5 ",(0,s.kt)("inlineCode",{parentName:"p"},"npm i @midwayjs/passport")," \u548c\u76f8\u5173\u7b56\u7565\u4f9d\u8d56\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"## \u5fc5\u9009\n$ npm i @midwayjs/passport@3 --save\n\n## \u53ef\u9009\n## \u4e0b\u9762\u5b89\u88c5\u672c\u5730\u7b56\u7565\n$ npm i passport-local --save\n$ npm i @types/passport-local --save-dev\n## \u4e0b\u9762\u5b89\u88c5 Github \u7b56\u7565\n$ npm i passport-github --save\n## \u4e0b\u9762\u5b89\u88c5 Jwt \u7b56\u7565\n$ npm i passport-jwt --save\n")),(0,s.kt)("p",null,"\u6216\u8005\u5728 ",(0,s.kt)("inlineCode",{parentName:"p"},"package.json")," \u4e2d\u589e\u52a0\u5982\u4e0b\u4f9d\u8d56\u540e\uff0c\u91cd\u65b0\u5b89\u88c5\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "dependencies": {\n    "@midwayjs/passport": "^3.0.0",\n    // \u672c\u5730\u7b56\u7565\n    "passport-local": "^1.0.0"\n    // Jwt \u7b56\u7565\n    "passport-jwt": "^4.0.0",\n    // Github \u7b56\u7565\n    "passport-github": "^1.1.0",\n    // ...\n  },\n  "devDependencies": {\n    // \u672c\u5730\u7b56\u7565\n    "@types/passport-local": "^1.0.34",\n    // Jwt \u7b56\u7565\n    "@types/passport-jwt": "^3.0.6",\n    // Github \u7b56\u7565\n    "@types/passport-github": "^1.1.7",\n    // ...\n  }\n}\n')),(0,s.kt)("h2",{id:"\u542f\u7528\u7ec4\u4ef6"},"\u542f\u7528\u7ec4\u4ef6"),(0,s.kt)("p",null,"\u9996\u5148\u542f\u7528\u7ec4\u4ef6\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\n\nimport { join } from 'path';\nimport { ILifeCycle,} from '@midwayjs/core';\nimport { Configuration } from '@midwayjs/decorator';\nimport * as passport from '@midwayjs/passport';\n\n@Configuration({\n  imports: [\n    // ...\n    passport,\n  ],\n  importConfigs: [join(__dirname, './config')],\n})\nexport class MainConfiguration implements ILifeCycle {}\n\n")),(0,s.kt)("h2",{id:"\u7b56\u7565\u793a\u4f8b"},"\u7b56\u7565\u793a\u4f8b"),(0,s.kt)("p",null,"\u8fd9\u91cc\u6211\u4eec\u4ee5\u4f7f\u7528\u672c\u5730\u8ba4\u8bc1\u7b56\u7565\uff0c\u548c Jwt \u7b56\u7565\u4f5c\u4e3a\u6f14\u793a\u3002"),(0,s.kt)("h3",{id:"\u793a\u4f8b\u672c\u5730\u7b56\u7565"},"\u793a\u4f8b\uff1a\u672c\u5730\u7b56\u7565"),(0,s.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 ",(0,s.kt)("inlineCode",{parentName:"p"},"@CustomStrategy")," \u548c\u6d3e\u751f ",(0,s.kt)("inlineCode",{parentName:"p"},"PassportStrategy")," \u6765\u81ea\u542f\u52a8\u4e00\u4e2a\u7b56\u7565\u3002\u901a\u8fc7 validate \u94a9\u5b50\u6765\u83b7\u53d6\u6709\u6548\u8d1f\u8f7d\uff0c\u5e76\u4e14\u6b64\u51fd\u6570\u5fc5\u987b\u6709\u8fd4\u56de\u503c\uff0c\u5176\u53c2\u6570\u5e76\u4e0d\u660e\u786e\uff0c\u53ef\u4ee5\u53c2\u8003\u5bf9\u5e94\u7684 Strategy \u6216\u8005\u901a\u8fc7\u5c55\u5f00\u7b26\u6253\u5370\u67e5\u770b\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/strategy/local.strategy.ts\n\nimport { CustomStrategy, PassportStrategy } from '@midwayjs/passport';\nimport { Strategy } from 'passport-local';\nimport { Repository } from 'typeorm';\nimport { InjectEntityModel } from '@midwayjs/typeorm';\nimport { UserEntity } from './user';\nimport * as bcrypt from 'bcrypt';\n\n@CustomStrategy()\nexport class LocalStrategy extends PassportStrategy(Strategy) {\n  @InjectEntityModel(UserEntity)\n  userModel: Repository<UserEntity>;\n\n  // \u7b56\u7565\u7684\u9a8c\u8bc1\n  async validate(username, password) {\n    const user = await this.userModel.findOne({ username });\n    if (await bcrypt.compare(password, user.password)) {\n      throw new Error('error password ' + username);\n    }\n\n    return {\n      username,\n      password,\n    };\n  }\n\n  // \u5f53\u524d\u7b56\u7565\u7684\u53c2\u6570\n  getStrategyOptions(): any {\n    return {};\n  }\n}\n\n")),(0,s.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,s.kt)("div",{parentName:"div",className:"admonition-heading"},(0,s.kt)("h5",{parentName:"div"},(0,s.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,s.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,s.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,s.kt)("div",{parentName:"div",className:"admonition-content"},(0,s.kt)("p",{parentName:"div"},"\u6ce8\u610f\uff1avalidate \u65b9\u6cd5\u662f\u793e\u533a\u7b56\u7565 verify \u7684 Promise \u5316\u66ff\u4ee3\u65b9\u6cd5\uff0c\u4f60\u65e0\u9700\u5728\u6700\u540e\u4f20\u9012 callback \u53c2\u6570\u3002"))),(0,s.kt)("p",null,"\u4f7f\u7528\u6d3e\u751f ",(0,s.kt)("inlineCode",{parentName:"p"},"PassportMiddleware"),"\u51fa\u4e00\u4e2a\u4e2d\u95f4\u4ef6\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/middleware/local.middleware.ts\n\nimport { Inject, Middleware } from '@midwayjs/decorator';\nimport { PassportMiddleware, AuthenticateOptions } from '@midwayjs/passport';\nimport { LocalStrategy } from './strategy/local.strategy.ts'\n\n@Middleware()\nexport class LocalPassportMiddleware extends PassportMiddleware(LocalStrategy) {\n  // \u8bbe\u7f6e AuthenticateOptions\n  getAuthenticateOptions(): Promise<AuthenticateOptions> | AuthenticateOptions {\n    return {\n      failureRedirect: '/login',\n    };\n  }\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controller.ts\nimport { Post, Inject, Controller } from '@midwayjs/decorator';\nimport { LocalPassportMiddleware } from './middleware/local.middleware.ts'\n\n@Controller('/')\nexport class LocalController {\n\n  @Post('/passport/local', { middleware: [LocalPassportMiddleware] })\n  async localPassport() {\n    console.log('local user: ', this.ctx.state.user);\n    return this.ctx.state.user;\n  }\n}\n")),(0,s.kt)("p",null,"\u4f7f\u7528curl \u6a21\u62df\u4e00\u6b21\u8bf7\u6c42\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'curl -X POST http://localhost:7001/passport/local -d \'{"username": "demo", "password": "1234"}\' -H "Content-Type: application/json"\n\n\u7ed3\u679c {"username": "demo", "password": "1234"}\n')),(0,s.kt)("h3",{id:"\u793a\u4f8bjwt-\u7b56\u7565"},"\u793a\u4f8b\uff1aJwt \u7b56\u7565"),(0,s.kt)("p",null,"\u9996\u5148\u9700\u8981 ",(0,s.kt)("strong",{parentName:"p"},"\u989d\u5916\u5b89\u88c5")," \u4f9d\u8d56\u548c\u7b56\u7565\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i @midwayjs/jwt passport-jwt --save\n")),(0,s.kt)("p",null,"\u989d\u5916\u542f\u7528 jwt \u7ec4\u4ef6\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// configuration.ts\n\nimport { join } from 'path';\nimport * as jwt from '@midwayjs/jwt';\nimport { ILifeCycle,} from '@midwayjs/core';\nimport { Configuration } from '@midwayjs/decorator';\nimport * as passport from '@midwayjs/passport';\n\n@Configuration({\n  imports: [\n    // ...\n    jwt,\n    passport,\n  ],\n  importConfigs: [join(__dirname, './config')],\n})\nexport class MainConfiguration implements ILifeCycle {}\n\n")),(0,s.kt)("p",null,"\u7136\u540e\u5728\u914d\u7f6e\u4e2d\u8bbe\u7f6e\uff0c\u9ed8\u8ba4\u672a\u52a0\u5bc6\uff0c\u8bf7\u4e0d\u8981\u628a\u654f\u611f\u4fe1\u606f\u5b58\u653e\u5728 payload \u4e2d\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  jwt: {\n    secret: 'xxxxxxxxxxxxxx', // fs.readFileSync('xxxxx.key')\n    expiresIn: '2d'   // https://github.com/vercel/ms\n  },\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/strategy/jwt.strategy.ts\n\nimport { CustomStrategy, PassportStrategy } from '@midwayjs/passport';\nimport { Strategy, ExtractJwt } from 'passport-jwt';\nimport { Config } from '@midwayjs/decorator';\n\n@CustomStrategy()\nexport class JwtStrategy extends PassportStrategy(\n  Strategy,\n  'jwt'\n) {\n  @Config('jwt')\n  jwtConfig;\n\n  async validate(payload) {\n    return payload;\n  }\n\n  getStrategyOptions(): any {\n    return {\n      secretOrKey: this.jwtConfig.secret,\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n    };\n  }\n}\n")),(0,s.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,s.kt)("div",{parentName:"div",className:"admonition-heading"},(0,s.kt)("h5",{parentName:"div"},(0,s.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,s.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,s.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,s.kt)("div",{parentName:"div",className:"admonition-content"},(0,s.kt)("p",{parentName:"div"},"\u6ce8\u610f\uff1avalidate \u65b9\u6cd5\u662f\u793e\u533a\u7b56\u7565 verify \u7684 Promise \u5316\u66ff\u4ee3\u65b9\u6cd5\uff0c\u4f60\u65e0\u9700\u5728\u6700\u540e\u4f20\u9012 callback \u53c2\u6570\u3002"))),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/middleware/jwt.middleware.ts\n\nimport { Middleware } from '@midwayjs/decorator';\nimport { PassportMiddleware, AuthenticateOptions } from '@midwayjs/passport';\nimport { JwtStrategy } from '../strategy/jwt-strategy';\n\n@Middleware()\nexport class JwtPassportMiddleware extends PassportMiddleware(JwtStrategy) {\n  getAuthenticateOptions(): Promise<AuthenticateOptions> | AuthenticateOptions {\n    return {};\n  }\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Post, Inject, Controller, } from '@midwayjs/decorator';\nimport { Context } from '@midwayjs/koa'\nimport { JwtService } from '@midwayjs/jwt';\nimport { JwtPassportMiddleware } from './middleware/jwt.middleware';\n\n@Controller('/')\nexport class JwtController {\n\n  @Inject()\n  jwt: JwtService;\n\n  @Inject()\n  ctx: Context;\n\n  @Post('/passport/jwt', { middleware: [JwtPassportMiddleware] })\n  async jwtPassport() {\n    console.log('jwt user: ', this.ctx.state.user);\n    return this.ctx.state.user;\n  }\n\n  @Post('/jwt')\n  async genJwt() {\n    return {\n      t: await this.jwt.sign({ msg: 'Hello Midway' }),\n    };\n  }\n}\n")),(0,s.kt)("p",null,"\u4f7f\u7528 curl \u6a21\u62df\u8bf7\u6c42"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'curl -X POST http://127.0.0.1:7001/jwt\n\n\u7ed3\u679c {"t": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"}\n\ncurl http://127.0.0.1:7001/passport/jwt -H "Authorization: Bearer xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"\n\n\u7ed3\u679c {"msg": "Hello Midway","iat": 1635468727,"exp": 1635468827}\n\n')),(0,s.kt)("h2",{id:"\u81ea\u5b9a\u4e49\u5176\u4ed6\u7b56\u7565"},"\u81ea\u5b9a\u4e49\u5176\u4ed6\u7b56\u7565"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"@midwayjs/passport")," \u652f\u6301\u81ea\u5b9a\u4e49",(0,s.kt)("a",{parentName:"p",href:"http://www.passportjs.org/packages/"},"\u5176\u4ed6\u7b56\u7565"),"\uff0c\u8fd9\u91cc\u4ee5 Github OAuth \u4e3a\u4f8b\u3002\n\u9996\u5148 ",(0,s.kt)("inlineCode",{parentName:"p"},"npm i passport-github"),"\uff0c\u4e4b\u540e\u7f16\u5199\u5982\u4e0b\u4ee3\u7801\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// github-strategy.ts\n\nimport { CustomStrategy, PassportStrategy } from '@midwayjs/passport';\nimport { Strategy, StrategyOptions } from 'passport-github';\n\nconst GITHUB_CLIENT_ID = 'xxxxxx', GITHUB_CLIENT_SECRET = 'xxxxxxxx';\n\n@CustomStrategy()\nexport class GithubStrategy extends PassportStrategy(Strategy, 'github') {\n  async validate(...payload) {\n    return payload;\n  }\n  getStrategyOptions() {\n    return {\n      clientID: GITHUB_CLIENT_ID,\n      clientSecret: GITHUB_CLIENT_SECRET,\n      callbackURL: 'https://127.0.0.1:7001/auth/github/cb'\n    };\n  }\n}\n\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/middleware/github.middleware.ts\n\nimport { PassportMiddleware } from '@midwayjs/passport';\nimport { Middleware } from '@midwayjs/decorator';\nimport { GithubStrategy } from './github-strategy.ts';\n\n@Middleware()\nexport class GithubPassportMiddleware extends PassportMiddleware(GithubStrategy) {\n  getAuthenticateOptions(): AuthenticateOptions | Promise<AuthenticateOptions> {\n    return {};\n  }\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/controoer/auth.controller.ts\n\nimport { Controller, Get, Inject } from '@midwayjs/decorator';\nimport { GithubPassportMiddleware } from './github.middleware';\n\n@Controller('/oauth')\nexport class AuthController {\n  @Inject()\n  ctx;\n\n  @Get('/github', { middleware: [GithubPassportMiddleware] })\n  async githubOAuth() {}\n\n  @Get('/github/cb', { middleware: [GithubPassportMiddleware] })\n  async githubOAuthCallback() {\n    return this.ctx.state.user;\n  }\n}\n\n")),(0,s.kt)("h2",{id:"\u7b56\u7565\u9009\u9879"},"\u7b56\u7565\u9009\u9879"),(0,s.kt)("table",null,(0,s.kt)("thead",{parentName:"table"},(0,s.kt)("tr",{parentName:"thead"},(0,s.kt)("th",{parentName:"tr",align:null},"\u9009\u9879"),(0,s.kt)("th",{parentName:"tr",align:null},"\u7c7b\u578b"),(0,s.kt)("th",{parentName:"tr",align:null},"\u63cf\u8ff0"))),(0,s.kt)("tbody",{parentName:"table"},(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:null},"failureRedirect"),(0,s.kt)("td",{parentName:"tr",align:null},"string"),(0,s.kt)("td",{parentName:"tr",align:null},"\u5931\u8d25\u8df3\u8f6c\u7684 url")),(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:null},"session"),(0,s.kt)("td",{parentName:"tr",align:null},"boolean"),(0,s.kt)("td",{parentName:"tr",align:null},"\u9ed8\u8ba4 true\uff0c\u5f00\u542f\u540e\uff0c\u4f1a\u81ea\u52a8\u5c06\u7528\u6237\u4fe1\u606f\u8bbe\u7f6e\u5230 session")),(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:null},"sessionUserProperty"),(0,s.kt)("td",{parentName:"tr",align:null},"string"),(0,s.kt)("td",{parentName:"tr",align:null},"\u8bbe\u7f6e\u5230 session \u4e0a\u7684 key\uff0c\u9ed8\u8ba4 user")),(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:null},"userProperty"),(0,s.kt)("td",{parentName:"tr",align:null},"string"),(0,s.kt)("td",{parentName:"tr",align:null},"\u8bbe\u7f6e\u5230 ctx.state \u6216\u8005 req \u4e0a\u7684 key\uff0c\u9ed8\u8ba4 user")),(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:null},"successRedirect"),(0,s.kt)("td",{parentName:"tr",align:null},"string"),(0,s.kt)("td",{parentName:"tr",align:null},"\u7528\u6237\u8ba4\u8bc1\u6210\u529f\u540e\u8df3\u8f6c\u7684\u5730\u5740")))),(0,s.kt)("h2",{id:"\u5e38\u89c1\u95ee\u9898"},"\u5e38\u89c1\u95ee\u9898"),(0,s.kt)("h3",{id:"1failed-to-serialize-user-into-session"},"1\u3001Failed to serialize user into session"),(0,s.kt)("p",null,"\u7531\u4e8e passport \u9ed8\u8ba4\u4f1a\u5c1d\u8bd5\u5c06 user \u6570\u636e\u5199\u5165session\uff0c\u5982\u679c\u65e0\u9700\u5c06\u7528\u6237\u4fdd\u5b58\u5230 session\uff0c\u53ef\u4ee5\u5c06 session \u652f\u6301\u5173\u95ed\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\nexport default {\n  // ...\n  passport: {\n    session: false,\n  }\n}\n")),(0,s.kt)("p",null,"\u5982\u679c\u660e\u786e\u9700\u8981\u4fdd\u5b58\u6570\u636e\u5230 Session\uff0c\u5219\u9700\u8981\u91cd\u5199 ",(0,s.kt)("inlineCode",{parentName:"p"},"PassportStrategy"),"\u7684 User \u7684\u5e8f\u5217\u5316\u65b9\u6cd5\uff0c\u8bf7\u4e0d\u8981\u4fdd\u5b58\u7279\u522b\u5927\u7684\u6570\u636e\u3002"),(0,s.kt)("p",null,"\u6bd4\u5982\u81ea\u5df1\u5b9e\u73b0\u7684\u672c\u5730\u7b56\u7565\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/strategy/local.strategy.ts\n\nimport { CustomStrategy, PassportStrategy } from '@midwayjs/passport';\nimport { Repository } from 'typeorm';\nimport { InjectEntityModel } from '@midwayjs/orm';\nimport { UserEntity } from './user';\nimport * as bcrypt from 'bcrypt';\n\n@CustomStrategy()\nexport class LocalStrategy extends PassportStrategy(Strategy) {\n\n  // ...\n  serializeUser(user, done) {\n    // \u53ef\u4ee5\u53ea\u4fdd\u5b58\u7528\u6237\u540d\n    done(null, user.username);\n  }\n\n  deserializeUser(id, done) {\n\n    // \u8fd9\u91cc\u4e0d\u662f\u5f02\u6b65\u65b9\u6cd5\uff0c\u4f60\u53ef\u4ee5\u4ece\u5176\u4ed6\u5730\u65b9\u6839\u636e\u7528\u6237\u540d\uff0c\u53cd\u67e5\u7528\u6237\u6570\u636e\u3002\n    const user = getUserFromDataBase(id);\n\n    done(null, user);\n  }\n}\n")))}u.isMDXComponent=!0}}]);