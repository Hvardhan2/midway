"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1753],{3905:function(t,e,n){n.d(e,{Zo:function(){return c},kt:function(){return m}});var r=n(7294);function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function s(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function o(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?s(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function p(t,e){if(null==t)return{};var n,r,a=function(t,e){if(null==t)return{};var n,r,a={},s=Object.keys(t);for(r=0;r<s.length;r++)n=s[r],e.indexOf(n)>=0||(a[n]=t[n]);return a}(t,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);for(r=0;r<s.length;r++)n=s[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(a[n]=t[n])}return a}var i=r.createContext({}),l=function(t){var e=r.useContext(i),n=e;return t&&(n="function"==typeof t?t(e):o(o({},e),t)),n},c=function(t){var e=l(t.components);return r.createElement(i.Provider,{value:e},t.children)},u={inlineCode:"code",wrapper:function(t){var e=t.children;return r.createElement(r.Fragment,{},e)}},d=r.forwardRef((function(t,e){var n=t.components,a=t.mdxType,s=t.originalType,i=t.parentName,c=p(t,["components","mdxType","originalType","parentName"]),d=l(n),m=a,x=d["".concat(i,".").concat(m)]||d[m]||u[m]||s;return n?r.createElement(x,o(o({ref:e},c),{},{components:n})):r.createElement(x,o({ref:e},c))}));function m(t,e){var n=arguments,a=e&&e.mdxType;if("string"==typeof t||a){var s=n.length,o=new Array(s);o[0]=d;var p={};for(var i in e)hasOwnProperty.call(e,i)&&(p[i]=e[i]);p.originalType=t,p.mdxType="string"==typeof t?t:a,o[1]=p;for(var l=2;l<s;l++)o[l]=n[l];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},6269:function(t,e,n){n.r(e),n.d(e,{assets:function(){return c},contentTitle:function(){return i},default:function(){return m},frontMatter:function(){return p},metadata:function(){return l},toc:function(){return u}});var r=n(7462),a=n(3366),s=(n(7294),n(3905)),o=["components"],p={title:"Passport"},i=void 0,l={unversionedId:"extensions/passport",id:"version-2.0.0/extensions/passport",title:"Passport",description:"\u8eab\u4efd\u9a8c\u8bc1\u662f\u5927\u591a\u6570 Web \u5e94\u7528\u7a0b\u5e8f\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\u3002\u56e0\u6b64 Midway \u5c01\u88c5\u4e86\u76ee\u524d Node.js \u4e2d\u6700\u6d41\u884c\u7684 Passport \u5e93\u3002",source:"@site/versioned_docs/version-2.0.0/extensions/passport.md",sourceDirName:"extensions",slug:"/extensions/passport",permalink:"/docs/2.0.0/extensions/passport",editUrl:"https://github.com/midwayjs/midway/tree/main/site/versioned_docs/version-2.0.0/extensions/passport.md",tags:[],version:"2.0.0",frontMatter:{title:"Passport"},sidebar:"component",previous:{title:"\u6a21\u677f\u6e32\u67d3",permalink:"/docs/2.0.0/extensions/render"},next:{title:"Database\uff08TypeORM)",permalink:"/docs/2.0.0/extensions/orm"}},c={},u=[{value:"\u51c6\u5907",id:"\u51c6\u5907",level:2},{value:"\u4f7f\u7528",id:"\u4f7f\u7528",level:2},{value:"e.g. \u672c\u5730\u7b56\u7565",id:"eg-\u672c\u5730\u7b56\u7565",level:3},{value:"e.g. Jwt",id:"eg-jwt",level:3},{value:"\u81ea\u5b9a\u4e49\u5176\u4ed6\u7b56\u7565",id:"\u81ea\u5b9a\u4e49\u5176\u4ed6\u7b56\u7565",level:2},{value:"\u4e00\u4e9b\u76f8\u5173\u8d44\u6599",id:"\u4e00\u4e9b\u76f8\u5173\u8d44\u6599",level:2}],d={toc:u};function m(t){var e=t.components,n=(0,a.Z)(t,o);return(0,s.kt)("wrapper",(0,r.Z)({},d,n,{components:e,mdxType:"MDXLayout"}),(0,s.kt)("p",null,"\u8eab\u4efd\u9a8c\u8bc1\u662f\u5927\u591a\u6570 Web \u5e94\u7528\u7a0b\u5e8f\u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\u3002\u56e0\u6b64 Midway \u5c01\u88c5\u4e86\u76ee\u524d Node.js \u4e2d\u6700\u6d41\u884c\u7684 Passport \u5e93\u3002"),(0,s.kt)("p",null,"Passport \u662f\u901a\u8fc7\u79f0\u4e3a\u7b56\u7565\u7684\u53ef\u6269\u5c55\u63d2\u4ef6\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\u8bf7\u6c42\u3002Passport \u4e0d\u6302\u8f7d\u8def\u7531\u6216\u5047\u8bbe\u4efb\u4f55\u7279\u5b9a\u7684\u6570\u636e\u5e93\uff0c\u8fd9\u6700\u5927\u9650\u5ea6\u5730\u63d0\u9ad8\u4e86\u7075\u6d3b\u6027\u5e76\u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u505a\u51fa\u5e94\u7528\u7a0b\u5e8f\u7ea7\u522b\u7684\u51b3\u7b56\u3002"),(0,s.kt)("h2",{id:"\u51c6\u5907"},"\u51c6\u5907"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"\u5b89\u88c5 ",(0,s.kt)("inlineCode",{parentName:"li"},"npm i @midwayjs/passport"))),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i @midwayjs/passport@2 passport --save\n$ npm i @types/passport --save-dev\n")),(0,s.kt)("ol",{start:2},(0,s.kt)("li",{parentName:"ol"},"\u5982\u679c\u4f60\u9700\u8981\u4fdd\u5b58\u5230 session \u4e2d\uff0c\u5f00\u542f\u76f8\u5bf9\u5e94\u6846\u67b6\u7684 session \u529f\u80fd")),(0,s.kt)("h2",{id:"\u4f7f\u7528"},"\u4f7f\u7528"),(0,s.kt)("p",null,"\u8fd9\u91cc\u6211\u4eec\u4ee5\u672c\u5730\u8ba4\u8bc1\uff0c\u548c JWT \u4f5c\u4e3a\u6f14\u793a\uff0c\u8fd9\u91cc\u7528\u5230\u4e86\u53e6\u4e00\u4e2a JWT \u7ec4\u4ef6\u3002"),(0,s.kt)("p",null,"\u9996\u5148"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\n\nimport { ILifeCycle } from '@midwayjs/core';\nimport { Configuration } from '@midwayjs/decorator';\nimport * as jwt from '@midwayjs/jwt';\nimport * as passport from '@midwayjs/passport';\n\n@Configuration({\n  imports: [jwt, passport],\n  // ...\n})\nexport class ContainerLifeCycle implements ILifeCycle {}\n")),(0,s.kt)("h3",{id:"eg-\u672c\u5730\u7b56\u7565"},"e.g. \u672c\u5730\u7b56\u7565"),(0,s.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 ",(0,s.kt)("inlineCode",{parentName:"p"},"@CustomStrategy")," \u548c\u6d3e\u751f ",(0,s.kt)("inlineCode",{parentName:"p"},"PassportStrategy"),"\u6765 \u81ea\u542f\u52a8\u4e00\u4e2a\u7b56\u7565\u3002\u901a\u8fc7 validate \u94a9\u5b50\u6765\u83b7\u53d6\u6709\u6548\u8d1f\u8f7d\uff0c\u5e76\u4e14\u6b64\u51fd\u6570\u5fc5\u987b\u6709\u8fd4\u56de\u503c\uff0c\u5176\u53c2\u6570\u5e76\u4e0d\u660e\u786e\uff0c\u53ef\u4ee5\u53c2\u8003\u5bf9\u5e94\u7684 Strategy \u6216\u8005\u901a\u8fc7\u5c55\u5f00\u7b26\u6253\u5370\u67e5\u770b\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// strategy/local.ts\n\nimport { CustomStrategy, PassportStrategy } from '@midwayjs/passport';\nimport * as bcrypt from 'bcrypt';\n\n@CustomStrategy()\nexport class LocalStrategy extends PassportStrategy(Strategy) {\n  async validate(user, password) {\n    // \u5b9e\u9645\u7684\u79d8\u94a5\n    const password = '*********';\n\n    // \u548c\u7528\u6237\u7684\u79d8\u94a5\u505a\u5bf9\u6bd4\n    const isLegalUser = await bcrypt.compare(password, user.password);\n    if (!isLegalUser) {\n      throw new Error('error password ' + user.name);\n    }\n\n    return {\n      user,\n      password,\n    };\n  }\n\n  // \u5f53\u524d\u7b56\u7565\u7684\u53c2\u6570\n  getStrategyOptions(): any {\n    return {\n      passwordField: 'pwd',\n    };\n  }\n}\n")),(0,s.kt)("p",null,"\u4e4b\u540e\u6d3e\u751f",(0,s.kt)("inlineCode",{parentName:"p"},"PassportMiddleware"),"\u51fa\u4e00\u4e2a\u4e2d\u95f4\u4ef6\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// local-middleware.ts\n\nimport { Inject, Provide } from '@midwayjs/decorator';\nimport { PassportMiddleware } from '@midwayjs/passport';\nimport { Context } from '@midwayjs/express';\n\n@Provide('local') // \u6b64\u5904\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u7b80\u77ed\u7684identifier\nexport class LocalPassportMiddleware extends PassportMiddleware(LocalStrategy) {\n  // \u8bbe\u7f6e AuthenticateOptions\n  getAuthenticateOptions(): Promise<passport.AuthenticateOptions> | passport.AuthenticateOptions {\n    return {\n      failureRedirect: '/login',\n      presetProperty: 'user',\n    };\n  }\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// controller.ts\n\nimport { Provide, Post, Inject, Controller } from '@midwayjs/decorator';\n\n@Provide()\n@Controller('/')\nexport class LocalController {\n  @Post('/passport/local', { middleware: ['local'] })\n  async localPassport() {\n    console.log('local user: ', this.ctx.req.user);\n    return this.ctx.req.user;\n  }\n}\n")),(0,s.kt)("p",null,"\u4f7f\u7528 curl \u6a21\u62df\u4e00\u6b21\u8bf7\u6c42\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'curl -X POST http://localhost:7001/passport/local -d \'{"username": "demo", "pwd": "1234"}\' -H "Content-Type: application/json"\n\n\u7ed3\u679c {"username": "demo", "pwd": "1234"}\n')),(0,s.kt)("h3",{id:""}),(0,s.kt)("p",null,"\u6ce8\u610f\uff0cexpress \u7684\u7528\u6237\u4fe1\u606f\u4f1a\u4fdd\u5b58\u5230 ",(0,s.kt)("inlineCode",{parentName:"p"},"req.user")," \uff0c\u800c koa/egg \u4f1a\u4fdd\u5b58\u5230 ",(0,s.kt)("inlineCode",{parentName:"p"},"ctx.state.user")," \u3002"),(0,s.kt)("h3",{id:"-1"}),(0,s.kt)("h3",{id:"eg-jwt"},"e.g. Jwt"),(0,s.kt)("p",null,"\u9996\u5148\u9700\u8981 ",(0,s.kt)("strong",{parentName:"p"},"\u989d\u5916\u5b89\u88c5")," \u4f9d\u8d56\u548c\u7b56\u7565\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i @midwayjs/jwt passport-jwt --save\n")),(0,s.kt)("p",null,"\u7136\u540e\u5728 config.ts \u4e2d\u914d\u7f6e\uff0c \u9ed8\u8ba4\u672a\u52a0\u5bc6\uff0c\u8bf7\u4e0d\u8981\u628a\u654f\u611f\u4fe1\u606f\u5b58\u653e\u5728 payload \u4e2d\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"export const jwt = {\n  secret: 'xxxxxxxxxxxxxx', // fs.readFileSync('xxxxx.key')\n  expiresIn: '2d', // https://github.com/vercel/ms\n};\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// jwt-strategy.ts\n\nimport { CustomStrategy, PassportStrategy } from '@midwayjs/passport';\nimport { Strategy, ExtractJwt } from 'passport-jwt';\n\n@CustomStrategy()\nexport class JwtStrategy extends PassportStrategy(Strategy) {\n  @Config('jwt')\n  jwtConfig;\n\n  async validate(payload) {\n    return payload;\n  }\n\n  getStrategyOptions(): any {\n    return {\n      secretOrKey: this.jwtConfig.secret,\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n    };\n  }\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// jwt-middleware.ts\n\nimport { Provide } from '@midwayjs/decorator';\nimport { PassportMiddleware } from '@midwayjs/passport';\n\n@Provide()\nexport class JwtPassportMiddleware extends PassportMiddleware(JwtStrategy) {\n  getAuthenticateOptions(): Promise<passport.AuthenticateOptions> | passport.AuthenticateOptions {\n    return {};\n  }\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide, Post, Inject } from '@midwayjs/decorator';\nimport { Controller, Post } from '@midwayjs/decorator';\nimport { JwtService } from '@midwayjs/jwt';\n\n@Provide()\n@Controller('/')\nexport class JwtController {\n\n  @Inject()\n  jwt: JwtService;\n\n  @Inject();\n  ctx: any;\n\n  @Post('/passport/jwt', { middleware: ['jwtPassportMiddleware'] })\n  async jwtPassport() {\n    console.log('jwt user: ', this.ctx.req.user);\n    return this.ctx.req.user;\n  }\n\n  @Post('/jwt')\n  async genJwt() {\n    return {\n      t: await this.jwt.sign({ msg: 'Hello Midway' }),\n    };\n  }\n}\n")),(0,s.kt)("p",null,"\u4f7f\u7528 curl \u6a21\u62df\u8bf7\u6c42"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'curl -X POST http://127.0.0.1:7001/jwt\n\n\u7ed3\u679c {"t": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"}\n\ncurl http://127.0.0.1:7001/passport/jwt -H "Authorization: Bearer xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"\n\n\u7ed3\u679c {"msg": "Hello Midway","iat": 1635468727,"exp": 1635468827}\n\n')),(0,s.kt)("h2",{id:"\u81ea\u5b9a\u4e49\u5176\u4ed6\u7b56\u7565"},"\u81ea\u5b9a\u4e49\u5176\u4ed6\u7b56\u7565"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"@midwayjs/passport")," \u652f\u6301\u81ea\u5b9a\u4e49",(0,s.kt)("a",{parentName:"p",href:"http://www.passportjs.org/packages/"},"\u5176\u4ed6\u7b56\u7565"),"\uff0c\u8fd9\u91cc\u4ee5 Github OAuth \u4e3a\u4f8b\u3002"),(0,s.kt)("p",null,"\u9996\u5148\u9700\u8981\u5b89\u88c5\u76f8\u5e94\u7684 passport \u5e93\u3002"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i passport-github --save\n")),(0,s.kt)("p",null,"\u7f16\u5199\u5982\u4e0b\u7b56\u7565\u4ee3\u7801\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// github-strategy.ts\n\nimport { CustomStrategy, PassportStrategy } from '@midwayjs/passport';\nimport { Strategy, StrategyOptions } from 'passport-github';\n\nconst GITHUB_CLIENT_ID = 'xxxxxx',\n  GITHUB_CLIENT_SECRET = 'xxxxxxxx';\n\n@CustomStrategy()\nexport class GithubStrategy extends PassportStrategy(Strategy) {\n  async validate(...payload) {\n    return payload;\n  }\n  getStrategyOptions() {\n    return {\n      clientID: GITHUB_CLIENT_ID,\n      clientSecret: GITHUB_CLIENT_SECRET,\n      callbackURL: 'https://127.0.0.1:7001/auth/github/cb',\n    };\n  }\n}\n")),(0,s.kt)("p",null,"\u63d0\u4f9b\u4e00\u4e2a\u4e2d\u95f4\u4ef6"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// github-middleware.ts\n\nimport { PassportMiddleware } from '@midwayjs/passport';\n\n@Provide()\nexport class GithubPassportMiddleware extends PassportMiddleware {}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript"},"// controller.ts\n\nimport { Provide, Get, Inject } from '@midwayjs/decorator';\n\n@Provide()\n@Controller('/oauth')\nexport class AuthController {\n  @Inject()\n  ctx: any;\n\n  @Get('/github', { middleware: ['githubPassportMiddleware'] })\n  async githubOAuth() {}\n\n  @Get('/github/cb', { middleware: ['githubPassportMiddleware'] })\n  async githubOAuthCallback() {\n    return this.ctx.req.user;\n  }\n}\n")),(0,s.kt)("h2",{id:"\u4e00\u4e9b\u76f8\u5173\u8d44\u6599"},"\u4e00\u4e9b\u76f8\u5173\u8d44\u6599"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html"},"JWT \u5165\u95e8"))))}m.isMDXComponent=!0}}]);